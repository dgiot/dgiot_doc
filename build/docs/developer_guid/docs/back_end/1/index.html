<!doctype html>
<html lang="中文" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer_guid/docs/back_end/1">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-141789564-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-226F0LR9KE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-226F0LR9KE",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="DGIOT让万物互联变得更简单" href="/opensearch.xml">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><title data-rh="true">后端技术 | DGIOT让万物互联变得更简单</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.iotn2n.com/docs/developer_guid/docs/back_end/1"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="后端技术 | DGIOT让万物互联变得更简单"><meta data-rh="true" name="description" content="分层架构"><meta data-rh="true" property="og:description" content="分层架构"><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://www.iotn2n.com/docs/developer_guid/docs/back_end/1"><link data-rh="true" rel="alternate" href="https://www.iotn2n.com/en/docs/developer_guid/docs/back_end/1" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.iotn2n.com/docs/developer_guid/docs/back_end/1" hreflang="中文"><link data-rh="true" rel="alternate" href="https://www.iotn2n.com/docs/developer_guid/docs/back_end/1" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YOUR_APP_ID-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.2af04dc8.css">
<link rel="preload" href="/assets/js/runtime~main.6f315219.js" as="script">
<link rel="preload" href="/assets/js/main.57a13c50.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_HglS">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="dgiot Logo" class="themedImage_CGMU themedImage--light_Ylij"><img src="/img/logo.png" alt="dgiot Logo" class="themedImage_CGMU themedImage--dark_s9Ac"></div><b class="navbar__title text--truncate">dgiot</b></a></div><div class="navbar__items navbar__items--right"><a href="http://www.dgiotcloud.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">首页<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.dgiotcloud.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">迪格云<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.dgiotcloud.cn/?page_id=5" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">产品<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/product_doc/">文档</a><a href="http://www.dgiotcloud.cn/?page_id=162" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.dgiotcloud.cn/?cat=1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">媒体<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/">解决方案</a><ul class="dropdown__menu"><li><a href="http://www.dgiotcloud.cn/?cat=4" target="_blank" rel="noopener noreferrer" class="dropdown__link">智慧工地</a></li><li><a href="http://www.dgiotcloud.cn/?cat=4" target="_blank" rel="noopener noreferrer" class="dropdown__link">智慧场馆</a></li><li><a href="http://www.dgiotcloud.cn/?cat=4" target="_blank" rel="noopener noreferrer" class="dropdown__link">数字工厂</a></li><li><a href="http://www.dgiotcloud.cn/?cat=4" target="_blank" rel="noopener noreferrer" class="dropdown__link">云检测</a></li><li><a href="http://www.dgiotcloud.cn/?cat=4" target="_blank" rel="noopener noreferrer" class="dropdown__link">云压测</a></li></ul></div><a href="http://www.dgiotcloud.cn/?cat=1" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">社区<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="http://www.dgiotcloud.cn/?page_id=2" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">联系我们<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_SNKZ"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（中国）</a><ul class="dropdown__menu"><li><a href="/en/docs/developer_guid/docs/back_end/1" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/docs/developer_guid/docs/back_end/1" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文（中国）</a></li></ul></div><a href="https://github.com/dgiot/dgiot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_a_OA colorModeToggle_mfwg"><button class="clean-btn toggleButton_PoXS toggleButtonDisabled_u2r9" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_JX7f"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qNy_"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_fhuM"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_woKB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sE6V" type="button"></button><div class="docPage_udwd"><aside class="theme-doc-sidebar-container docSidebarContainer_tp0e"><div class="sidebar_mJ1T"><nav class="menu thin-scrollbar menu_IwTI"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/user_manual/">用户手册</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/user_manual/">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/user_manual/docs/equipment_operational/1">设备运维</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/user_manual/docs/wisdom_park/1">智慧园区</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/user_manual/docs/digital_factory/1">数字工厂</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/user_manual/docs/detection/1">云检测</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/user_manual/docs/pressure_test/1">云压测</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/product_doc/">产品文档</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/product_doc/">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/introduction/1">简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/equipment_cloud/1">设备云</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/multi-tenant/1">多租户</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/cloud_operations/1">云运维</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/cloud_function/1">云函数</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/cloud_system/1">云系统</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/cloud_detection/1">云检测</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/product_doc/docs/cloud_log/1">云日志</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/developer_guid/">开发指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer_guid/">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer_guid/docs/back_end/1">后端技术</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer_guid/docs/back_end/1">后端技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer_guid/docs/back_end/architecture">太阳能管理平台</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer_guid/docs/back_end/1">前端技术</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer_guid/docs/back_end/1">后端技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer_guid/docs/back_end/architecture">太阳能管理平台</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer_guid/docs/back_end/1">时序数据(TDengine)</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer_guid/docs/back_end/1">后端技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer_guid/docs/back_end/architecture">太阳能管理平台</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/practical_tutorial/">实战教程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/">基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/1">视频教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/2">PT100传感器接入教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/3">电力集抄教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/4">DDZY1296电表接入教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/5">三合一传感器接入教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/6">Mqtt设备接入教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/7">水泵性能曲线测量案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/8">OPC-DA设备接入教程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/9">摄像头接入</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/practical_tutorial/docs/10">测试</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_zJkW"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Q_mj"><div class="docItemContainer_JmQI"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Un1X" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_insn"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">开发指南</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">后端技术</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">后端技术</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_zuUZ theme-doc-toc-mobile tocMobile_VP8e"><button type="button" class="clean-btn tocCollapsibleButton_TDB4">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>后端技术</h1></header><h2 class="anchor anchorWithStickyNavbar_nANs" id="分层架构"><strong>分层架构</strong><a class="hash-link" href="#分层架构" title="Direct link to heading">​</a></h2><p>在应用系统开发中，采用严格的、单一的、真正的的分层架构是可以的，但实际上我们已经采用了多种架构模式设计系统。当多种不同范式的架构混合在一起，你会不会出现“指鹿为马”的现象呢？</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="严格分层架构"><strong>严格分层架构</strong><a class="hash-link" href="#严格分层架构" title="Direct link to heading">​</a></h3><p>在研究分层架构时，常通过概念性的定义或 OSI 七层应用（架构）来说明或解释分层架构：</p><blockquote><p>架构模式 Layers 有助于将应用程序划分为多组子任务，其中每组子任务都位于特定抽象层。</p></blockquote><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/osi.png" alt="osi.png" class="img_xIgF"></p><p>图片取自《 POSA , Vol.I , p22 》</p><p>作为一个在项目中引入分层架构的应用者，我们应该从更具体的规范来实现分层架构：</p><ul><li>相邻层之间<strong>必须是单向耦合</strong>。上层只能依赖下层，下层永远不能依赖上层。</li><li>相邻层之间<strong>必须是单向通信</strong>。上层去调用下层所提供的接口，下层永远不能调用上层的接口。</li></ul><p>《 POSA , Vol.I 》 为我们提供了更多的实现规范，然而我要解决的是有关层的<strong>单向依赖</strong>问题。因为有一些人在使用分层架构时，尤其是将分层架构引入到项目的目录结构时，对于某些对象的划分（从属）存在一些混乱问题。</p><p>如果你有兴趣了解更多分层架构的实现规范，可参考：《 POSA , Vol.I 》第二十六页到第二十九页相关知识。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="松散分层架构relaxed-layered-system"><strong>松散分层架构（Relaxed Layered System）</strong><a class="hash-link" href="#松散分层架构relaxed-layered-system" title="Direct link to heading">​</a></h3><p>在领域驱动设计（DDD）中采用的是<strong>松散分层架构</strong>，层间关系不那么严格。每层都可能使用它下面所有层的服务，而不仅仅是下一层的服务。每层都可能是半透明的，这意味着有些服务只对上一层可见，而有些服务对上面的所有层都可见。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/osi1.png" alt="osi1.png" class="img_xIgF"></p><p>注意：松散分层架构依然是单向依赖，表明上层只能调用下层的服务，下层不能调用上层的服务。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="继承分层架构layering-through-inheritance"><strong>继承分层架构（Layering Through Inheritance）</strong><a class="hash-link" href="#继承分层架构layering-through-inheritance" title="Direct link to heading">​</a></h3><p>同时在领域驱动设计（DDD）中也采用了<strong>继承分层架构</strong>，高层继承并实现低层接口。我们需要调整一下各层的顺序，并且将<strong>基础设施层</strong>移动到最高层。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/osi2.png" class="img_xIgF"></p><p>注意：继承分层架构依然是单向依赖，这也意味着领域层、应用层、表现层将不能依赖基础设施层，相反基础设施层可以依赖它们。</p><p>领域层 UserRepository 接口：</p><div class="language-auto codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-auto codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">package com.mallfoundry.user.domain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface UserRepository {    User save(User user);}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>基础设施层 JpaUserRepository 实现类：</p><div class="language-auto codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-auto codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">package com.mallfoundry.user.infrastructure.persistence;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JpaUserRepository implements UserRepository {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EntityManager entityManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public JpaUserRepository(EntityManager entityManager) {        this.entityManager = entityManager;    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override    public User save(User user) {        return this.entityManager.merge(user);    }}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="包package与分层架构"><strong>包（Package）与分层架构</strong><a class="hash-link" href="#包package与分层架构" title="Direct link to heading">​</a></h3><p>我们确实使用包来划分层级，但是包名并不能真正表示分层。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="资源库repository"><strong>资源库（Repository）</strong><a class="hash-link" href="#资源库repository" title="Direct link to heading">​</a></h3><p>我们通常将资源库的实现放置在基础设施层，这是因为我们采用了<strong>继承分层架构</strong>。如果你现在采用的是<strong>松散分层架构</strong>，你需要将资源库的实现放置在领域层。这是层的单向依赖原则所致，你不应该破坏这个原则。没有任何理由需要破坏分层架构的单向依赖原则，除非你不采用分层架构。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="三层或四层架构"><strong>三层或四层架构</strong><a class="hash-link" href="#三层或四层架构" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/osi3.png" class="img_xIgF"></p><p>我们应该从混乱到有序的这个历史过程去研究（分析）分层架构，尤其是我们现在处在前后端分离的环境下，应用系统使用分层架构又面临着什么样的划分变化。</p><ul><li>第一个阶段：应用系统只有两层：表示（现）层和数据库层。在视图中直接使用数据库所提供的访问接口操作数据，如：JDBC，在视图中<strong>直接使用</strong> <code>ResultSet</code> 表示数据。（需要特别注意的是：在视图中直接使用 <code>ResultSet</code> 。）</li><li>第二个阶段：应用系统划分为三层：表现层、领域层和数据库层。在这个阶段，我们已经开始意识到模型了，模型的出现意味着在视图中不在直接使用 <code>ResultSet</code> 了，而是使用从 <code>ResultSet</code> 相映射的编程语言中的结构体（struct）或者对象类（class）。这表示：从编程语言中的表示法可以抽象业务域中的概念结构了。</li><li>第三个阶段：应用系统划分为四层：表现层、应用（业务）逻辑层、领域层和数据库层。由于业务逻辑依然存在视图中，我们需要将视图中的业务逻辑与视图分离出来，此时出现了应用层。同时表现层也有所推进，<strong>表现层</strong>使用 MVC 架构。通过在 Controller 调用应用层所提供的接口并获得接口所返回的模型（model）数据，并在 Controller 中将 model 和 view 组合起来，最终完成渲染工作。正是因为在表现层使用 MVC 架构使得视图（view）与下层实现松耦合。</li></ul><p>应用系统使用分层架构在第三阶段基本已经成熟。因为我们要探讨的是有关领域驱动设计（DDD）的分层架构，所以我们依然需要做进一步补充。具体包括两方面的补充：</p><ul><li>第四个阶段：面向对象的发展与应用，这个阶段对总的层次划分没有大的变化。具体的变化的是有关应用层与领域层的内容，更具体的来说是领域层的变化。面向对象的出现使得大家开始使用面向对象来设计领域模型。这表示：由<strong>属性</strong>和<strong>操作</strong>所表示的对象模型用来抽象业务域中的概念模型。同时这又表示应用（业务）逻辑层中的业务逻辑也将被<strong>对象领域模型</strong>所承担，应用层只需要<strong>控制</strong>与<strong>协调</strong>有关对象领域模型的相关逻辑。非常幸运的是，Eric 对这一现象中的更多细节做了非常系统性的阐述，最终形成《领域驱动设计》这本书。</li><li>第五个阶段：前后端分离后对分层架构的影响。在前后端分离的项目中，表现层被完全的从后端剥离出来，后端只需要提供接口数据，如：RESTful , gRPC , Thrift , GraphQL 协议的后端接口。此时后端还是不是四层架构呢？这确实伴随着两条发展路线：一条是服务于前端的后端模式（BFF）。另一条是基于聚合对象的接口模式。它们的区别在于 BFF 频繁变化，后者不会因为前端频繁变化而变化。</li></ul><h2 class="anchor anchorWithStickyNavbar_nANs" id="三种模式">三种模式<a class="hash-link" href="#三种模式" title="Direct link to heading">​</a></h2><p>引言</p><p>在讨论DDD分层架构的模式之前，我们先一起回顾一下DDD和分层架构的相关知识。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="ddd"><strong>DDD</strong><a class="hash-link" href="#ddd" title="Direct link to heading">​</a></h3><p>DDD（Domain Driven Design，领域驱动设计）作为一种软件开发方法，它可以帮助我们设计高质量的软件模型。在正确实现的情况下，我们通过DDD完成的设计恰恰就是软件的工作方式。</p><p>UL（Ubiquitous Language，通用语言）是团队共享的语言，是DDD中最具威力的特性之一。不管你在团队中的角色如何，只要你是团队的一员，你都将使用UL。由于UL的重要性，所以需要让每个概念在各自的上下文中是清晰无歧义的，于是DDD在战略设计上提出了模式BC（Bounded Context，限界上下文）。UL和BC同时构成了DDD的两大支柱，并且它们是相辅相成的，即UL都有其确定的上下文含义，而BC中的每个概念都有唯一的含义。</p><p>一个业务领域划分成若干个BC，它们之间通过Context Map进行集成。BC是一个显式的边界，领域模型便存在于这个边界之内。领域模型是关于某个特定业务领域的软件模型。通常，领域模型通过对象模型来实现，这些对象同时包含了数据和行为，并且表达了准确的业务含义。</p><p>从广义上来讲，领域即是一个组织所做的事情以及其中所包含的一切，表示整个业务系统。由于“领域模型”包含了“领域”这个词，我们可能会认为应该为整个业务系统创建一个单一的、内聚的和全功能式的模型。然而，这并不是我们使用DDD的目标。正好相反，领域模型存在于BC内。</p><p>在微服务架构实践中，人们大量地使用了DDD中的概念和技术：</p><ol><li>微服务中应该首先建立UL，然后再讨论领域模型。</li><li>一个微服务最大不要超过一个BC，否则微服务内会存在有歧义的领域概念。</li><li>一个微服务最小不要小于一个聚合，否则会引入分布式事务的复杂度。</li><li>微服务的划分过程类似于BC的划分过程，每个微服务都有一个领域模型。</li><li>微服务间的集成可以通过Context Map来完成，比如ACL（Anticorruption Layer，防腐层）。</li><li>微服务间最好采用Domain Event（领域事件）来进行交互，使得微服务可以保持松耦合。</li><li>……</li></ol><h3 class="anchor anchorWithStickyNavbar_nANs" id="分层架构-1"><strong>分层架构</strong><a class="hash-link" href="#分层架构-1" title="Direct link to heading">​</a></h3><p>分层架构的好处是显而易见的。首先，由于层间松散的耦合关系，使得我们可以专注于本层的设计，而不必关心其他层的设计，也不必担心自己的设计会影响其它层，对提高软件质量大有裨益。其次，分层架构使得程序结构清晰，升级和维护都变得十分容易，更改某层的具体实现代码，只要本层的接口保持稳定，其他层可以不必修改。即使本层的接口发生变化，也只影响相邻的上层，修改工作量小且错误可以控制，不会带来意外的风险。</p><p>要保持程序分层架构的优点，就必须坚持层间的松散耦合关系。设计程序时，应先划分出可能的层次，以及此层次提供的接口和需要的接口。设计某层时，应尽量保持层间的隔离，仅使用下层提供的接口。</p><p>关于分层架构的优点，Martin Fowler在《Patterns of Enterprise Application Architecture》一书中给出了答案：</p><ol><li>开发人员可以只关注整个结构中的某一层。</li><li>可以很容易的用新的实现来替换原有层次的实现。</li><li>可以降低层与层之间的依赖。</li><li>有利于标准化。</li><li>利于各层逻辑的复用。</li></ol><p>“金无足赤，人无完人”，分层架构也不可避免具有一些缺陷：</p><ol><li>降低了系统的性能。这是显然的，因为增加了中间层，不过可以通过缓存机制来改善。</li><li>可能会导致级联的修改。这种修改尤其体现在自上而下的方向，不过可以通过依赖倒置来改善。</li></ol><p>在每个BC中为了凸显领域模型，DDD中提出了分层架构模式。最近几年，笔者在实践DDD的过程中，也经常使用分层架构模式，本文主要分享DDD分层架构中比较经典的三种模式。</p><p>模式一：四层架构</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/1.png" class="img_xIgF"></p><p>Eric Evans在《领域驱动设计－软件核心复杂性应对之道》这本书中提出了传统的四层架构模式，如下图所示：</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/2.png" class="img_xIgF"></p><ol><li>User Interface为用户界面层（或表示层），负责向用户显示信息和解释用户命令。这里指的用户可以是另一个计算机系统，不一定是使用用户界面的人。</li><li>Application为应用层，定义软件要完成的任务，并且指挥表达领域概念的对象来解决问题。这一层所负责的工作对业务来说意义重大，也是与其它系统的应用层进行交互的必要渠道。应用层要尽量简单，不包含业务规则或者知识，而只为下一层中的领域对象协调任务，分配工作，使它们互相协作。它没有反映业务情况的状态，但是却可以具有另外一种状态，为用户或程序显示某个任务的进度。</li><li>Domain为领域层（或模型层），负责表达业务概念，业务状态信息以及业务规则。尽管保存业务状态的技术细节是由基础设施层实现的，但是反映业务情况的状态是由本层控制并且使用的。领域层是业务软件的核心，领域模型位于这一层。</li><li>Infrastructure层为基础实施层，向其他层提供通用的技术能力：为应用层传递消息，为领域层提供持久化机制，为用户界面层绘制屏幕组件，等等。基础设施层还能够通过架构框架来支持四个层次间的交互模式。</li></ol><p>传统的四层架构都是限定型松散分层架构，即Infrastructure层的任意上层都可以访问该层（“L”型），而其它层遵守严格分层架构。</p><p>笔者在四层架构模式的实践中，对于分层的本地化定义主要为：</p><ol><li>User Interface层主要是Restful消息处理，配置文件解析，等等。</li><li>Application层主要是多进程管理及调度，多线程管理及调度，多协程调度和状态机管理，等等。</li><li>Domain层主要是领域模型的实现，包括领域对象的确立，这些对象的生命周期管理及关系，领域服务的定义，领域事件的发布，等等。</li><li>Infrastructure层主要是业务平台，编程框架，第三方库的封装，基础算法，等等。</li></ol><p>说明：严格意义上来说，User Interface指的是用户界面，Restful消息和配置文件解析等处理应该放在Application层，User Interface层没有的话就空缺。但User Interface也可以理解为用户接口，所以将Restful消息和配置文件解析等处理放在User Interface层也行。</p><p>模式二：五层架构</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/3.png" class="img_xIgF"></p><p>James O. Coplien和Trygve Reenskaug在2009年发表了一篇论文《DCI架构：面向对象编程的新构想》，标志着DCI架构模式的诞生。有趣的是James O. Coplien也是MVC架构模式的创造者，这个大叔一辈子就干了两件事，即年轻时创造了MVC和年老时创造了DCI，其他时间都在思考，让我辈望尘莫及。</p><p>面向对象编程的本意是将程序员与用户的视角统一于计算机代码之中：对提高可用性和降低程序的理解难度来说，都是一种恩赐。可是虽然对象很好地反映了结构，但在反映系统的动作方面却失败了，DCI的构想是期望反映出最终用户的认知模型中的角色以及角色之间的交互。</p><p>传统上，面向对象编程语言拿不出办法去捕捉对象之间的协作，反映不了协作中往来的算法。就像对象的实例反映出领域结构一样，对象的协作与交互同样是有结构的。协作与交互也是最终用户心智模型的组成部分，但你在代码中找不到一个内聚的表现形式去代表它们。在本质上，角色体现的是一般化的、抽象的算法。角色没有血肉，并不能做实际的事情，归根结底工作还是落在对象的头上，而对象本身还担负着体现领域模型的责任。</p><p>人们心目中对“对象”这个统一的整体却有两种不同的模型，即“系统是什么”和“系统做什么”，这就是DCI要解决的根本问题。用户认知一个个对象和它们所代表的领域，而每个对象还必须按照用户心目中的交互模型去实现一些行为，通过它在用例中所扮演的角色与其他对象联结在一起。正因为最终用户能把两种视角合为一体，类的对象除了支持所属类的成员函数，还可以执行所扮演角色的成员函数，就好像那些函数属于对象本身一样。换句话说，我们希望把角色的逻辑注入到对象，让这些逻辑成为对象的一部分，而其地位却丝毫不弱于对象初始化时从类所得到的方法。我们在编译时就为对象安排好了扮演角色时可能需要的所有逻辑。如果我们再聪明一点，在运行时才知道了被分配的角色，然后注入刚好要用到的逻辑，也是可以做到的。</p><p>算法及角色-对象映射由Context拥有。Context“知道”在当前用例中应该找哪个对象去充当实际的演员，然后负责把对象“cast”成场景中的相应角色（cast 这个词在戏剧界是选角的意思，此处的用词至少符合该词义，另一方面的用意是联想到cast 在某些编程语言类型系统中的含义）。在典型的实现里，每个用例都有其对应的一个Context 对象，而用例涉及到的每个角色在对应的Context 里也都有一个标识符。Context 要做的只是将角色标识符与正确的对象绑定到一起。然后我们只要触发Context里的“开场”角色，代码就会运行下去。</p><p>于是我们有了完整的DCI架构（Data、Context和Interactive三层架构）：</p><ol><li>Data层描述系统有哪些领域概念及其之间的关系，该层专注于领域对象的确立和这些对象的生命周期管理及关系，让程序员站在对象的角度思考系统，从而让“系统是什么”更容易被理解。</li><li>Context层：是尽可能薄的一层。Context往往被实现得无状态，只是找到合适的role，让role交互起来完成业务逻辑即可。但是简单并不代表不重要，显示化context层正是为人去理解软件业务流程提供切入点和主线。</li><li>Interactive层主要体现在对role的建模，role是每个context中复杂的业务逻辑的真正执行者，体现“系统做什么”。role所做的是对行为进行建模，它联接了context和领域对象。由于系统的行为是复杂且多变的，role使得系统将稳定的领域模型层和多变的系统行为层进行了分离，由role专注于对系统行为进行建模。该层往往关注于系统的可扩展性，更加贴近于软件工程实践，在面向对象中更多的是以类的视角进行思考设计。</li></ol><p>DCI目前广泛被看作是对DDD的一种发展和补充，用在基于面向对象的领域建模上。显式的对role进行建模，解决了面向对象建模中的充血模型和贫血模型之争。DCI通过显式的用role对行为进行建模，同时让role在context中可以和对应的领域对象进行绑定(cast)，从而既解决了数据边界和行为边界不一致的问题，也解决了领域对象中数据和行为高内聚低耦合的问题。</p><p>面向对象建模面临的一个棘手问题是数据边界和行为边界往往不一致。遵循模块化的思想，我们通过类将行为和其紧密耦合的数据封装在一起。但是在复杂的业务场景下，行为往往跨越多个领域对象，这样的行为如果放在某一个对象中必然会导致别的对象需要向该对象暴漏其内部状态。所以面向对象发展的后来，领域建模出现两种派别之争，一种倾向于将跨越多个领域对象的行为建模在领域服务中。如果这种做法使用过度，则会导致领域对象变成只提供一堆get方法的哑对象，这种建模结果被称之为贫血模型。而另一派则坚定的认为方法应该属于领域对象，所以所有的业务行为仍然被放在领域对象中，这样导致领域对象随着支持的业务场景变多而变成上帝类，而且类内部方法的抽象层次很难一致。另外由于行为边界很难恰当，导致对象之间数据访问关系也比较复杂，这种建模结果被称之为充血模型。</p><p>关于多角色对象，举个生活中的例子：</p><ul><li>人有多重角色，不同的角色履行的职责不同：</li><li>作为父母：我们要给孩子讲故事，陪他们玩游戏，哄它们睡觉。</li><li>作为子女：我们要孝敬父母，听取他们的人生建议。</li><li>作为下属：我们要服从上司的工作安排，并高质量完成任务。</li><li>作为上司：我们要安排下属的工作，并进行培养和激励。</li><li>……</li></ul><p>这里人（大对象）聚合了多个角色（小类），人在某种场景下，只能扮演特定的角色：</p><ul><li>在孩子面前，我们是父母。</li><li>在父母面前，我们是子女。</li><li>在上司面前，我们是下属。</li><li>在下属面前，我们是上司。</li><li>……</li></ul><p>引入DCI后，DDD四层架构模式中的Domain层变薄了，以前Domain层对应DCI中的三层，而现在：</p><ol><li><p>Domain层只保留了DCI中的Data层和Interaction层，我们在实践中通常将这两层使用目录隔离，即通过两个目录object和role来分离层Data和Interaction。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/4.png" class="img_xIgF"></p></li><li><p>DCI中的Context层从Domain层上移变成Context层。</p></li></ol><p>因此，DDD分层架构模式就变成了五层，如下图所示：</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/5.png" class="img_xIgF"></p><p>笔者在实践中，将这五层的本地化定义为：</p><ol><li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Application层的接口。</li><li>Application层是应用层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Context层与本次业务相关的上下文进行处理。</li><li>Context是环境层，以上下文为单位，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。</li><li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li><li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li></ol><p>DDD五层架构模式讨论完了吗？故事还没有结束……</p><p>笔者参与的很多DDD落地实践，都是面向控制面或管理面且消息交互比较多的系统。这类系统的一次业务，包含一组同步消息或异步消息构成的序列，如果都放在Context层，会导致该层的代码比较复杂，于是我们考虑：</p><ol><li>Context层在面向控制面或管理面且消息交互比较多的系统中又分裂成两层，即Context层和大Context层。</li><li>Context层处理单位为Action，对应一条同步消息或异步消息。</li><li>大Context层对应一个事务处理，由一个Action序列组成，一般通过Transaction DSL实现，所以我们习惯把大Context层叫做Transaction DSL层。</li><li>Application层在面向控制面或管理面且消息交互比较多的系统中经常会做一些调度相关的工作，所以我们习惯把Application层叫做Scheduler层。</li></ol><p>因此，在面向控制面或管理面且消息交互比较多的系统中，DDD分层架构模式就变成了六层，如下图所示：</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/6.png" class="img_xIgF"></p><p>笔者在实践中，将这六层的本地化定义为：</p><ol><li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Scheduler层的接口。</li><li>Scheduler是调度层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Transaction层与本次操作相关的事务进行处理。</li><li>Transaction是事务层，对应一个业务流程，比如UE Attach，将多个同步消息或异步消息的处理序列组合成一个事务，而且在大多场景下，都有选择结构。万一事务执行失败，则立即进行回滚。当事务层收到调度层的请求后，委托Context层的Action进行处理，常常还伴随使用Context层的Specification（谓词）进行Action的选择。</li><li>Context是环境层，以Action为单位，处理一条同步消息或异步消息，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。环境层通常也包括Specification的实现，即通过Domain层的知识去完成一个条件判断。</li><li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li><li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li></ol><p>事务层的核心是事务模型，事务模型的框架代码一般放在基础设施层。关于事务模型，笔者以前分享过一篇文章——《Golang事务模型<!-- -->[<!-- -->1<!-- -->]<!-- -->》，感兴趣的同学可以看看。</p><p>综上所述，DDD六层架构可以看做是DDD五层架构在特定领域的变体，我们统称为DDD五层架构，而DDD五层架构与传统的四层架构类似，都是限定型松散分层架构。</p><p>模式三：六边形架构</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/3.png" class="img_xIgF"></p><p>有一种方法可以改进分层架构，即依赖倒置原则（Dependency Inversion Principle，DIP），它通过改变不同层之间的依赖关系达到改进目的。</p><p>依赖倒置原则由Robert C. Martin提出，正式定义为：</p><ul><li>高层模块不应该依赖于底层模块，两者都应该依赖于抽象。</li><li>抽象不应该依赖于细节，细节应该依赖于抽象。</li></ul><p>根据该定义，DDD分层架构中的低层组件应该依赖于高层组件提供的接口，即无论高层还是低层都依赖于抽象，整个分层架构好像被推平了。如果我们把分层架构推平，再向其中加入一些对称性，就会出现一种具有对称性特征的架构风格，即六边形架构。六边形架构是Alistair Cockburn在2005年提出的，在这种架构中，不同的客户通过“平等”的方式与系统交互。需要新的客户吗？不是问题。只需要添加一个新的适配器将客户输入转化成能被系统API所理解的参数就行。同时，对于每种特定的输出，都有一个新建的适配器负责完成相应的转化功能。</p><p>六边形架构也称为端口与适配器，如下图所示：</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/7.png" class="img_xIgF"></p><p>六边形每条不同的边代表了不同类型的端口，端口要么处理输入，要么处理输出。对于每种外界类型，都有一个适配器与之对应，外界通过应用层API与内部进行交互。上图中有3个客户请求均抵达相同的输入端口（适配器A、B和C），另一个客户请求使用了适配器D。假设前3个请求使用了HTTP协议（浏览器、REST和SOAP等），而后一个请求使用了AMQP协议（比如RabbitMQ）。端口并没有明确的定义，它是一个非常灵活的概念。无论采用哪种方式对端口进行划分，当客户请求到达时，都应该有相应的适配器对输入进行转化，然后端口将调用应用程序的某个操作或者向应用程序发送一个事件，控制权由此交给内部区域。</p><p>应用程序通过公共API接收客户请求，使用领域模型来处理请求。我们可以将DDD战术设计的建模元素Repository的实现看作是持久化适配器，该适配器用于访问先前存储的聚合实例或者保存新的聚合实例。正如图中的适配器E、F和G所展示的，我们可以通过不同的方式实现资源库，比如关系型数据库、基于文档的存储、分布式缓存或内存存储等。如果应用程序向外界发送领域事件消息，我们将使用适配器H进行处理。该适配器处理消息输出，而上面提到的处理AMQP消息的适配器则是处理消息输入的，因此应该使用不同的端口。</p><p>我们在实际的项目开发中，不同层的组件可以同时开发。当一个组件的功能明确后，就可以立即启动开发。由于该组件的用户有多个，并且这些用户的侧重点不同，所以需要提供多个不同的接口。同时，这些用户的认识也是不断深入的，可能会多次重构相关的接口。于是，组件的多个用户经常会找组件的开发者讨论这些问题，无形中降低了组件的开发效率。</p><p>我们换一种方式，组件的开发者在明确了组件的功能后就专注于功能的开发，确保功能稳定和高效。组件的用户自己定义组件的接口（端口），然后基于接口写测试，并不断演进接口。在跨层集成测试时，由组件开发者或用户再开发一个适配器就可以了。</p><p>六边形架构模式的演变</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/3.png" class="img_xIgF"></p><p>尽管六边形架构模式已经很好，但是没有最好只有更好，演变没有尽头。在六边形架构模式提出后的这些年，又依次衍生出三种六边形架构模式的变体，感兴趣的读者可以自行学习：</p><ol><li>Jeffrey Palermo在2008年提出了洋葱架构，六边形架构是洋葱架构的一个超集。</li><li>Robert C. Martin在2012年提出了干净架构（Clean Architecture），这是六边形架构的一个变体。</li><li>Russ Miles在2013年提出了Life Preserver设计，这是一种基于六边形架构的设计。</li></ol><h3 class="anchor anchorWithStickyNavbar_nANs" id="小结">小结<a class="hash-link" href="#小结" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/ddd/3.png" class="img_xIgF"></p><p>本文先和读者一起回顾了DDD和分层架构的相关知识，然后将DDD分层架构中常用的三种模式（四层架构、五层架构和六边形架构）结合实践经验分别进行详细阐述，使得读者深刻理解DDD分层架构模式，以便在微服务的开发实践中根据具体情况选择最合适的DDD分层架构模式，从而交付结构清晰且易维护的软件产品。</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="多租户">多租户<a class="hash-link" href="#多租户" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="前言">前言<a class="hash-link" href="#前言" title="Direct link to heading">​</a></h3><p>   随着大量SaaS公司进入市场，我们看到颠覆性的软件服务以各种方式进入企业流程-从营销工具到支付系统。随着SaaS帮助优化业务流程，实现更流畅和自动化的运营，风险投资公司首先潜入池中寻找最优秀和最聪明的企业。</p><p>   从Zoom(一家提供结合了视频会议，在线会议，聊天和移动协作的通信软件)上市,阿里收购Teambition，SaaS正成为风险投资公司和创业极其有利可图的途径。为了了解SaaS,PaaS,下面将对其进行简单的概述。</p><p>   如果您正在考虑将您的业务迁移到云端，有三个词将萦绕在你耳边:</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="iaas技术设施即服务">IaaS(技术设施即服务)<a class="hash-link" href="#iaas技术设施即服务" title="Direct link to heading">​</a></h3><p>  <strong>解释</strong></p><p>   IaaS企业提供诸如即时即付存储，网络和虚拟化等服务。</p><p>   IaaS为用户提供了基于云的内部基础架构替代方案，因此企业可以避免投资昂贵的现场资源。</p><p>  <strong>优势</strong></p><p>   维护内部部署的IT基础架构既昂贵又耗费人力。</p><p>   它通常需要在物理硬件上进行大量的初始投资，然后您可能需要聘请外部IT承包商来维护硬件并保持一切正常运行和最新。通过IaaS，您可以根据需要购买所需的产品，并随着业务的增长购买更多产品。</p><p>  <strong>特点</strong></p><p>  ​ IaaS平台是：</p><ul><li><p>高度灵活，高度可扩展。</p></li><li><p>可供多个用户访问。</p></li><li><p>性价比高。</p><p> <strong>示例</strong></p><p> ​ IaaS示例: 阿里云服务器ECS, AWS EC2Google Compute Engine（GCE）。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="paas平台即服务">PaaS(平台即服务)<a class="hash-link" href="#paas平台即服务" title="Direct link to heading">​</a></h3><p><strong>解释</strong></p><p>​ PaaS供应商通过互联网提供硬件和软件工具，人们使用这些工具开发应用程序。PaaS用户往往是开发人员。</p><p><strong>优势</strong></p><p>​ PaaS主要由正在构建软件或应用程序的开发人员使用。PaaS解决方案为开发人员提供了创建独特，可定制软件的平台。</p><p>​ 这意味着开发人员在创建应用程序时无需从头开始，在编写大量代码时节省了大量时间（和金钱）。PaaS是那些想要创造独特应用程序而又不花钱或承担全部责任的企业的热门选择。</p><p><strong>特点</strong></p><p>​ PaaS平台是：</p></li><li><p>可供多个用户访问。</p></li><li><p>可扩展 - 您可以从各种级别的资源中进行选择，以适应您的业务规模。</p></li><li><p>基于虚拟化技术。</p></li><li><p>无需广泛的系统管理知识即可轻松运行。</p><p><strong>示例</strong></p><p>​ PaaS示例: AWS Elastic Beanstalk，Heroku，Windows Azure（主要用作PaaS）。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_nANs" id="saas软件施即服务">SaaS(软件施即服务)<a class="hash-link" href="#saas软件施即服务" title="Direct link to heading">​</a></h3><p><strong>解释</strong></p><p>​ SaaS平台通过互联网向用户提供软件，通常每月订阅费用。</p><p><strong>优势</strong></p><p>​ 使用SaaS，您无需在计算机（或任何计算机）上安装和运行软件应用程序。当您在线登录帐户时，一切都可通过互联网获得。您通常可以随时从任何设备访问该软件（只要有互联网连接）。使用该软件的其他人也是如此。您的所有员工都将拥有适合其访问级别的个性化登录。</p><p>​ 另一个关键优势是支付结构:</p><p>​ 大多数SaaS提供商都使用固定的包含性月度帐户费用来运营订阅模式。您确切地知道软件的成本是多少，并且可以相应地进行预算，而不必担心隐藏的意外。</p><p>​ 大多数订阅包括维护，合规性和安全性服务，这在使用内部部署软件时可能既耗时又昂贵。SaaS提供商还提供易于设置的开箱即用解决方案（如果您需要基本软件包），并为大型组织提供更复杂的解决方案。您可以在几小时内启动并运行基本软件 - 并且您可以在此过程中获得客户服务和支持。</p><p><strong>特点</strong></p><p>​ SaaS平台是：</p><ul><li>可通过互联网获得。</li><li>由第三方提供商托管在远程服务器上。</li><li>可扩展，具有适用于小型，中型和企业级业务的不同层。</li><li>包容性，提供安全性，合规性和维护作为成本的一部分</li></ul><p><strong>示例</strong></p><p>​ SaaS示例: BigCommerce，Google Apps，Salesforce，Dropbox，MailChimp，ZenDesk，DocuSign，Slack，Hubspot。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="多租户-1">多租户<a class="hash-link" href="#多租户-1" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="什么是多租户">什么是多租户<a class="hash-link" href="#什么是多租户" title="Direct link to heading">​</a></h4><p>聊到PaaS,SaaS，就不得不谈到多租户。</p><p>  多租户指一套系统能够支撑多个租户。一个租户通常是具有相似访问模式和权限的一组用户，典型的租户是同一个组织或者公司的若干用户。</p><p>  要实现多租户，首先需要考虑的是数据层面的多租户。数据层的多租户模型对上层服务和应用的多租户实现有突出影响。本文重点介绍数据层多租户对各种多租户模型的支持。</p><p>权衡不同的多租户实现方式时，需要考虑如下因素：</p><ul><li>扩展性：租户数量级别，以及未来发展趋势</li><li>安全性：租户之间数据隔离级别要求</li><li>资源共享：多租户通常有某种形式的资源共享，需要避免某个租户的糟糕SQL吃掉系统资源，影响其他租户的响应时间</li><li>灵活性：不同租户可能有不同的需求，对特定租户需求的扩展能力</li><li>跨租户分析和优化：对全部租户或者多个租户的数据和行为进行分析的能力</li><li>运维和管理：运维管理的复杂度和便宜性，包括监控、修改数据库模式、创建索引、收集统计数据、数据加载等</li><li>成本：总体拥有成本，包括方案实现成本、运维成本等</li></ul><h4 class="anchor anchorWithStickyNavbar_nANs" id="多租户模型">多租户模型<a class="hash-link" href="#多租户模型" title="Direct link to heading">​</a></h4><p>多租户模型描述了租户和该租户的数据之间的映射关系。不同的多租户模型会影响数据库和应用程序的设计、管理和维护。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="一租户一数据库">一租户一数据库<a class="hash-link" href="#一租户一数据库" title="Direct link to heading">​</a></h4><p>  最简单的多租户实现方式是为每一个租户创建一个数据库，如下图所示。应用程序为每个租户分配一个租户id，并为每个租户配置相应的数据库连接信息（包括数据库ip、端口等）。应用程序根据租户id连接到为其分配的数据库。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/tenant/%E4%B8%80%E7%A7%9F%E6%88%B7%E4%B8%80%E6%95%B0%E6%8D%AE%E5%BA%93.png" alt="一租户一数据库.png" class="img_xIgF"></p><p>这种模型中不同租户的数据物理隔离，安全级别高。如果每个租户的数据库使用不同的硬件和数据库类型，则他们之间的资源使用也是物理隔离的；如果租户的数据库共用同一套硬件，则需要对资源进行合理分配和管理，避免相互影响。由于不同租户使用独立的数据库，灵活性好，容易满足不同租户的特定需求（譬如需要额外的字段）。出现故障时影响面小。缺点是数据库数量大，维护复杂，拥有成本高。适合租户数目比较少的场景。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="一租户一名字空间schemanamespace">一租户一名字空间（Schema/Namespace）<a class="hash-link" href="#一租户一名字空间schemanamespace" title="Direct link to heading">​</a></h4><p>  多个租户共享同一个数据库，每个租户拥有独立的名字空间（或模式）。应用程序为每个租户分配一个id，并把每个租户的所有操作限制在为其分配的名字空间/模式之中。如下图所示。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/tenant/%E4%B8%80%E7%A7%9F%E6%88%B7%E4%B8%80%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.png" alt="一租户一命名空间.png" class="img_xIgF"></p><p>  这种多租户模型下，不同租户的数据逻辑上相互隔离，安全控制相对简单。不同租户有不同的模式，可以简便的满足不同租户的特定需求，灵活性高。对资源管理能力要求高，以避免不同租户竞争资源。可以把不同租户的数据存储在不同的磁盘上，降低了对磁盘IO的竞争。运维和管理较复杂，不易实现大量租户的跨租户分析。适合租户数目适中的场景。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="全共享方式">全共享方式<a class="hash-link" href="#全共享方式" title="Direct link to heading">​</a></h4><p>  不同租户共享同一个数据库、同一个名字空间。不同租户的数据在同一组表中共存，通过租户id标记和访问不同租户的数据（应用需要调整访问数据的SQL以包含租户id）。如下图所示。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/tenant/%E5%85%A8%E5%85%B1%E4%BA%AB%E6%96%B9%E5%BC%8F.png" alt="全共享方式.png" class="img_xIgF"></p><p>这种多租户模型中，不同租户的数据物理存储在一起，对系统的资源隔离和安全隔离要求很高。运维相对简单。扩展能力好，可以支持较多数量租户。由于租户数据存储在一起，跨租户数据分析和优化非常简单。成本低，可以较低的代价支持更多的租户。</p><p>全共享模型中，很多数据库采用添加大量自定义字段的方式满足不同租户的特定需求，以提高灵活性。这种方式有诸多局限性，譬如字段数目不能太多、管理复杂等。支持更多半结构化数据，包括JSON 等，通过这种半结构化数据，可以更灵活、高效、便捷的满足不同租户的特定需求。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="案例剖析">案例剖析<a class="hash-link" href="#案例剖析" title="Direct link to heading">​</a></h3><p>  下面我通过用一个简单的全共享数据库的多租户模式的案例，来对PaaS平台型软件进行演示。</p><p>  系统账户层级如下图所示:</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/tenant/Multitenancy.png" alt="Multitenancy.png" class="img_xIgF"></p><p>在上图这个系统用户的层级关系中，我们需要四张表:</p><ul><li><p>ga_user:此表用于存储PaaS平台T1内所有的账户相关信息，如<a href="mailto:laowang@test.com" target="_blank" rel="noopener noreferrer">laowang@test.com</a>,<a href="mailto:zhangshan@test.com" target="_blank" rel="noopener noreferrer">zhangshan@test.com</a>,<a href="mailto:jingwa@test.com" target="_blank" rel="noopener noreferrer">jingwa@test.com</a>等账户和密码。此表用于登录平台时，系统认证和权限控制时所用。</p></li><li><p>tenant:用于存储所有的租户信息，如SaaS A, SaaS B,SaaS C。</p></li><li><p>customer:用于存储所有的客户信息，如消费客户/组织S1,消费客户/组织S2。</p></li><li><p>device:用于存储平台内所有客户，租户的设备相关信息。</p></li></ul><p>具体流程,可以概括为:</p><p>  我们用PaaS平台系统管理员帐号<a href="mailto:laowang@test.com" target="_blank" rel="noopener noreferrer">laowang@test.com</a>登录系统。</p><p>  在系统中，新建SaaS A, SaaS B,SaaS C三个组织或者客户，并为这三个租户分配各种租户的租户管理员账户，分别为<a href="mailto:zhangsan@test.com" target="_blank" rel="noopener noreferrer">zhangsan@test.com</a>, <a href="mailto:lisi@test.com" target="_blank" rel="noopener noreferrer">lisi@test.com</a>,<a href="mailto:wangwu@test.com" target="_blank" rel="noopener noreferrer">wangwu@test.com</a>。当我们用这三个账户登录系统时，系统根据租户id和相应的权限显示对应的框架内容和组织信息。</p><p>  这三个组织利用PaaS平台上的服务框架和应用为需要的客户和组织提供一站式解决方案，有点类似我们采用阿里云平台上的服务框架来解决自己的企业需求。</p><p>  当SaaS B具体到实施项目时，为消费客户/组织S1或消费客户/组织S2分配帐号进行公有云订阅服务，进行项目迭代交付或者本地化实施。</p><p>UML实体图如下:</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/tenant/Mlti%20tenancy%20UML%20.png" alt="Mlti tenancy UML .png" class="img_xIgF"></p><h2 class="anchor anchorWithStickyNavbar_nANs" id="插件机制">插件机制<a class="hash-link" href="#插件机制" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="目录结构">目录结构<a class="hash-link" href="#目录结构" title="Direct link to heading">​</a></h3><p>rebar3插件目录结构如下：</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">dgiot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|——lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-dgiot_demoplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |- ebin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   |- dgiot_demopugin.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - dgiot_demoplugin.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - dgiot_demoplugin_app.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - dgiot_demoplugin_sup.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - dgiot_demonplugin_channel.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    - dgiot_demonplugin_handler.beam  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   -dgiot_otherplugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |- ebin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    |- dgiot_otherplugin.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     - dgiot_otherplugin.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     - dgiot_otherplugin_app.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     - dgiot_otherplugin_sup.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     - dgiot_otherplugin_channel.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     - dgiot_otherplugin_handler.beam </span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="示例代码">示例代码<a class="hash-link" href="#示例代码" title="Direct link to heading">​</a></h3><div class="language-erlang codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-erlang codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">  %%%-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @author johnliu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @copyright (C) 2021, &lt;COMPANY&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @doc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% Created : 24. 3月 2021 10:17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%%-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -module(dgiot_demonplugin_channel).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -author(&quot;johnliu&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -behavior(dgiot_channelx).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -include(&quot;dgiot_demonplugin.hrl&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -define(TYPE, &lt;&lt;&quot;demonplugin&quot;&gt;&gt;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -record(state, {id}).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -export([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      start/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% Channel callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -export([init/3, handle_init/1, handle_event/3, handle_message/2, stop/3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -channel(?TYPE).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -channel_type(#{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type =&gt; 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      title =&gt; #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          zh =&gt; &lt;&lt;&quot;demonplugin通道&quot;/utf8&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      description =&gt; #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          zh =&gt; &lt;&lt;&quot;demonplugin通道&quot;/utf8&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% 注册通道参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -params(#{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;&lt;&quot;port&quot;&gt;&gt; =&gt; #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          order =&gt; 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          type =&gt; integer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          required =&gt; true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          default =&gt; 51889,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          title =&gt; #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              zh =&gt; &lt;&lt;&quot;服务器端口&quot;/utf8&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          description =&gt; #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              zh =&gt; &lt;&lt;&quot;服务器端口&quot;/utf8&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start(ChannelId, ChannelArgs) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dgiot_channelx:add(?TYPE, ChannelId, ?MODULE, ChannelArgs).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% 通道初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  init(?TYPE, ChannelId, Args) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      #{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;&lt;&quot;ip&quot;&gt;&gt; := Ip,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;&lt;&quot;port&quot;&gt;&gt; := Port,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;&lt;&quot;total&quot;&gt;&gt; := Total} = Args,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do_something(&lt;&lt;&quot;hello plugin&quot;&gt;&gt;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      State = #state{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          id = ChannelId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {ok, State, []}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle_init(State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {ok, State}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %% 通道消息处理,注意：进程池调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle_event(_EventId, Event, State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lager:info(&quot;channel ~p&quot;, [Event]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {ok, State}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  handle_message(_Message, State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {ok, State}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stop(ChannelType, ChannelId, _State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ok.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_something(Msg) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   io:format(&quot;Msg ~p&quot;,[Msg]).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="加载机制">加载机制<a class="hash-link" href="#加载机制" title="Direct link to heading">​</a></h3><ul><li>搜索到所有已经加载的插件
application:loaded_applications()</li><li>通过App名称搜索ebin下面所有的beam文件
file:list_dir(Dir)</li><li>搜素对应beam文件内的attributes是否包含channel
Mod:module_info(attributes)</li><li>如果有channele的attributes则启动插件
Mod:start(ChannelId, ChannelArgs)
</li></ul><p>示例代码如下：</p><div class="language-erlang codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-erlang codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">  %%%-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @author johnliu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @copyright (C) 2019, &lt;COMPANY&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @doc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% @end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%% Created : 06. 八月 2019 18:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  %%%-------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -module(dgiot_plugin).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -author(&quot;johnliu&quot;).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-define(SYS_APP, [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kernel, stdlib, sasl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([start/0]) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    check_module(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fun({_App, _Vsn, Mod}, Acc) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case code:is_loaded(Mod) =/= false of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                true -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case lists:keyfind(channel, 1, Mod:module_info(attributes)) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        false -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            Acc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        {channel, ChannelTypes} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            do_somthing()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                false -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end, []).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  check_module(Check, Acc0) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Fun =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          fun({App, _Desc, Vsn}, Acc) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Dir = lists:concat([&quot;lib/&quot;, App, &quot;-&quot;, Vsn, &quot;/ebin&quot;]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              case not lists:member(App, ?SYS_APP) andalso file:list_dir(Dir) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  {ok, FS} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      lists:foldl(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          fun(FileName, Acc1) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              case filename:extension(FileName) == &quot;.beam&quot; of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  true -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Mod = list_to_atom(filename:basename(FileName, &quot;.beam&quot;)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Check({App, Vsn, Mod}, Acc1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  false -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      Acc1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          end, Acc, FS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  _ -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      Acc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          end,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lists:foldl(Fun, Acc0, application:loaded_applications()).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  do_somthing() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_nANs" id="网页代理">网页代理<a class="hash-link" href="#网页代理" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="反向代理">反向代理<a class="hash-link" href="#反向代理" title="Direct link to heading">​</a></h3><table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td>源路径</td><td>keypath</td></tr><tr><td>源host</td><td>127.0.0.1:5080</td></tr><tr><td>目标host</td><td><a href="http://www.iotn2n.com" target="_blank" rel="noopener noreferrer">www.iotn2n.com</a></td></tr><tr><td>协议</td><td>http</td></tr><tr><td>x-forwarded-for</td><td>true</td></tr></tbody></table><p> 配置词典内容如下：</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key&quot;:&quot;keypath&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;data&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;host&quot;: &quot;www.iotn2n.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;protocol&quot;: &quot;http&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;x-forwarded-for&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在浏览器里面输入
<a href="http://127.0.0.1:5080/dgiotproxy/%5Bkeypath%5D/%5Botherpath%5D" target="_blank" rel="noopener noreferrer">http://127.0.0.1:5080/dgiotproxy/[keypath]/[otherpath]</a></p><p>则返回反向代理路径结果</p><p><a href="http://www.iotn2n.com/%5Botherpath%5D" target="_blank" rel="noopener noreferrer">http://www.iotn2n.com/[otherpath]</a></p><h3 class="anchor anchorWithStickyNavbar_nANs" id="爬虫代理">爬虫代理<a class="hash-link" href="#爬虫代理" title="Direct link to heading">​</a></h3><p>htlm-&gt;tokens功能
功能类似于 BeautifulSoup 的爬虫功能</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain"> [{&lt;&lt;&quot;class&quot;&gt;&gt;,&lt;&lt;&quot;my-photo&quot;&gt;&gt;},{&lt;&lt;&quot;alt&quot;&gt;&gt;,&lt;&lt;&quot;loading&quot;&gt;&gt;},{&lt;&lt;&quot;style&quot;&gt;&gt;,&lt;&lt;&quot;cursor: pointer;&quot;&gt;&gt;},{&lt;&lt;&quot;data-src&quot;&gt;&gt;,&lt;&lt;&quot;http://132.232.12.21:8012/202158151241/0.jpg&quot;&gt;&gt;},{&lt;&lt;&quot;src&quot;&gt;&gt;,&lt;&lt;&quot;images/loading.gif&quot;&gt;&gt;}]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain"> shuwa_html:find(WordPreview, {&lt;&lt;&quot;img&quot;&gt;&gt;, {&lt;&lt;&quot;class&quot;&gt;&gt;, &lt;&lt;&quot;my-photo&quot;&gt;&gt;}}, &lt;&lt;&quot;data-src&quot;&gt;&gt;)</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="网页代理-1">网页代理<a class="hash-link" href="#网页代理-1" title="Direct link to heading">​</a></h3><p>tokens-&gt;html功能
可以动态生成网页</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="扩展编程">扩展编程<a class="hash-link" href="#扩展编程" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="反向代理-1">反向代理<a class="hash-link" href="#反向代理-1" title="Direct link to heading">​</a></h3><table><thead><tr><th>字段</th><th>值</th></tr></thead><tbody><tr><td>源路径</td><td>oldpath</td></tr><tr><td>目标路径</td><td>newpath</td></tr><tr><td>源host</td><td>127.0.0.1:5080</td></tr><tr><td>目标host</td><td><a href="http://www.iotn2n.com" target="_blank" rel="noopener noreferrer">www.iotn2n.com</a></td></tr><tr><td>协议</td><td>http</td></tr><tr><td>modify_path</td><td>true</td></tr><tr><td>x-forwarded-for</td><td>true</td></tr></tbody></table><p> 配置词典内容如下：</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;key&quot;:&quot;oldpath&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;data&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;host&quot;: &quot;www.iotn2n.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;protocol&quot;: &quot;http&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;modify_path&quot;: &quot;newpath&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;x-forwarded-for&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在浏览器里面输入
<a href="http://127.0.0.1:5080/dgiotproxy/oldpath" target="_blank" rel="noopener noreferrer">http://127.0.0.1:5080/dgiotproxy/oldpath</a></p><p>则返回反向代理路径结果</p><p><a href="http://www.iotn2n.com/newpath" target="_blank" rel="noopener noreferrer">http://www.iotn2n.com/newpath</a></p><h2 class="anchor anchorWithStickyNavbar_nANs" id="编程规范">编程规范<a class="hash-link" href="#编程规范" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="摘要">摘要<a class="hash-link" href="#摘要" title="Direct link to heading">​</a></h3><p>本文档提供了如何使用Erlang开发软件系统的规则和建议。</p><p>注意
本文档是一份初步且不完全的文档。 本文档不包含对于EBC的“Base System”的需求，然而，如果需要使用&quot;Base System&quot;, 在设计初期必须遵循此类需求。这些需求包含在文档&quot;1/10268-AND 10406 Uen “MAP - Start and Error Recovery”&quot;中。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="目标">目标<a class="hash-link" href="#目标" title="Direct link to heading">​</a></h3><p>本文列出了使用Erlang编写软件系统需要考虑到的一些方面的内容。这里不会给出与使用Erlang无关的通用细节和设计活动的完整描述。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="结构和erlang术语">结构和Erlang术语<a class="hash-link" href="#结构和erlang术语" title="Direct link to heading">​</a></h3><p>Erlang系统被划分为不同的模块(module)。模块由函数和属性组成。仅当函数在模块内或者被导出时才对调用该函数的其他函数所在模块可见。属性以&quot;-&quot;开头并且放在模块的起始位置。</p><p>在使用Erlang设计的系统中，具体工作由进程(processes)②完成。进程是一个可以使用不同模块中函数的任务。不同进程间通过消息传递进行通信。进程可以接收发送给它的消息，一个进程可以决定哪些消息已经准备好被接收。其他消息会被放入队列中，直到该进程已做好接收此消息的准备。</p><p>通过设置一个链接(link)，一个进程可以监视另一个进程。当一个进程挂起时，它将自动给其被链接的其他进程发送退出信号(exit signals)。进程接收到退出信号的默认行为是挂起该进程，同时传递该信号给其链接的其他进程。通过捕捉信号，进程可以改变上述默认行为，这将使所有发送给某进程的退出信号转换成消息。</p><p>纯函数(pure function)是指无论调用该函数的上下文如何，给定相同参数都返回相同结果的函数。这与我们通常对数学函数的期待一致。一般说来，非纯函数有副作用(side effect)。 副作用通常发生在一个函数</p><p>发送一条消息</p><p>接收一条消息</p><p>调用exit</p><p>调用任何改变进程环境或操作方式的内置函数(BIF)(例如:get/1, put/2, erase/1, process_flag/2等)</p><p>警告:本文包含了一些bad code的例子，这些例子用这种&quot;Ugly font&quot;书写。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="sw工程原则">SW工程原则<a class="hash-link" href="#sw工程原则" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="从一个模块尽可能少地导出函数">从一个模块尽可能少地导出函数<a class="hash-link" href="#从一个模块尽可能少地导出函数" title="Direct link to heading">​</a></h4><p>模块是Erlang中的基本代码结构实体。一个模块可包含大量函数，然而只有包含在导出列表中的函数才能在该模块外调用。</p><p>从外部观察一个模块的复杂度取决于从该模块导出函数的数量。一个仅导出一两个函数的模块通常比导出大量函数的模块更易于理解。</p><p>导出/未导出函数比率低的模块正是其使用者仅需要理解从该模块导出函数功能时所需要的。</p><p>另外，代码的作者或维护者在模块中可以以任意合适的方式改变其内部结构，而其提供给外部的接口保持不变。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="尽量减少模块间的依赖">尽量减少模块间的依赖<a class="hash-link" href="#尽量减少模块间的依赖" title="Direct link to heading">​</a></h4><p>调用更多其他模块的模块更加难以维护。 这是由于每当我们改变了一个模块的接口时，必须检查代码中所有调用该模块的地方。减少模块间的依赖可以简化维护这些模块时产生的问题。 我们可以通过减少被某一模块调用的其他模块的数量来简化系统结构。 同时要注意我们更希望模块间互相调用的依赖关系采用树状结构而非回环图。例如:</p><p>而不是:</p><p>将常用函数放入库中 常用的函数应该放在库中。库是相关函数的集合。应尽量保证库中包含的函数类型相同。所以像lists这样的库中仅包含操作列表的函数是一个好的选择，反之，一个库名为lists_and_maths包括操作列表和数学函数的集合则相反。 最好的库应该没有副作用。包含有副作用函数的库限制了其可重用性。</p><p>将复杂的(tricky)和脏代码(dirty)分离在不同的模块中 通常混合使用简洁和肮脏的代码可以解决问题。但请将二者分别放在不同模块中。</p><p>脏代码是做了一些使代码变脏事情的代码。例如: 使用了进程字典③</p><p>出于奇怪的目的使用了erlang:process_info/1 做了任何你不想（却不得不做）的事情</p><p>尽量集中精力使简洁的代码数量最大化同时使脏代码数量最小化。 分离脏代码并注释它们或者在文档中清晰描述这些代码的副作用和相关的问题。</p><p>不要假设调用者会对函数返回结果会如何处理</p><p>不要对函数被调用的原因或调用者将对返回结果的操作作出假设。 例如，假设我们调用某函数（原文 run time）期间传入了非法参数，函数实现者不应假设传入非法参数后其调用者所做的事情。 所以我们不应编写这样的代码:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">do_something(Args) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">case check_args(Args) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ok -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {ok, do_it(Args)};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {error, What} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String = format_the_error(What),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io:format(&quot;* error:~s\n&quot;, [String]), %% Don’t do this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">正确的写法如下:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_something(Args) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">case check_args(Args) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ok -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {ok, do_it(Args)};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {error, What} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {error, What}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_report({error, What}) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">format_the_error(What).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前一种情况下总是使用标准输出打印错误信息，而后一种则将错误类型返回给应用程序。应用程序此时可以根据错误信息决定下一步做什么。 在必要时，应用程序可以通过调用error_report/1将错误信息描述转换成可打印字符串并打印。但这也许不是我们所需要的 —— 在任何情况下，对结果处理的决定权应交由调用者。④</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="抽象出代码常用模式或行为">抽象出代码常用模式或行为<a class="hash-link" href="#抽象出代码常用模式或行为" title="Direct link to heading">​</a></h4><p>无论何时，当代码中有两处或更多相同代码形式，尽量把这些相同的部分单独放在一个函数中并调用它，而不是在不同的地方放置相同的代码段。</p><p>如果在代码中两个或更多地方有类似形式(甚至是相同)的代码，有必要花时间看看是否其中一个问题可以稍作修改使两处相同，然后写一些更小的代码(函数)来描述两者的差异。</p><p>编程时避免“复制”、“粘贴”，使用函数(代替他们)。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="自顶向下">自顶向下<a class="hash-link" href="#自顶向下" title="Direct link to heading">​</a></h4><p>采用自顶向下的方法编程，而不是自底向上(从细节开始)。通过定义函数原型，自顶向下是一种成功处理实现细节的好方法。由于设计上层代码好时下层代码所代表的内容是未知的，所以代码应独立于其所代表的内容。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="不要优化代码">不要优化代码<a class="hash-link" href="#不要优化代码" title="Direct link to heading">​</a></h3><p>不要在开始时优化代码。首先保证其正确，其次(必要时)使它运行的更快(同时保证代码正确)。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="采用-最小惊讶astonishment定律">采用 “最小惊讶(astonishment)定律”<a class="hash-link" href="#采用-最小惊讶astonishment定律" title="Direct link to heading">​</a></h4><p>对用户而言，系统响应时应保证产生最少的意外 —— 例如，当用户做了某种操作后，应能够对系统反应作出预测且不会对产生的结果感到惊讶。</p><p>这与一致性有关，不同模块以相似方式处理问题的一致的系统要比各模块以不同的方式处理问题的系统更易于理解。</p><p>如果你对函数运行结果感到惊讶，那么不是函数处理了错误的问题就是其命名有误。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="尽量减小副作用">尽量减小副作用<a class="hash-link" href="#尽量减小副作用" title="Direct link to heading">​</a></h4><p>Erlang包含一些有副作用的原始设计。由于这些函数会导致环境永久的改变所以它们不容易被重用，同时在使用它们之前你必须清楚地了解进程的状态。</p><p>尽可能写不包含副作用的代码。</p><p>使纯函数的数量最大化。</p><p>将有副作用的代码整合在一起并清晰地在文档中说明其副作用。</p><p>稍稍注意一下，大部分代码可以避免产生副作用。这将使系统易于维护、测试和理解。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要使模块的私有数据结构泄露">不要使模块的私有数据结构泄露<a class="hash-link" href="#不要使模块的私有数据结构泄露" title="Direct link to heading">​</a></h4><p>通过一个简单的例子可以最好的说明这一点。我们定义一个简单的模块并命名为queue —— 用来实现队列。</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-module(Queue).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([add/2, fetch/1]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add(Item, Q) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lists:append(Q, [Item]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([H|T]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, H, T};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    empty.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里使用列表来实现队列，不幸的是这样做用户必须知道队列代表一个列表。一个使用以上代码典型的程序代码段如下:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">NewQ = [], % Don’t do this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Queue1 = queue:add(joe, NewQ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Queue2 = queue:add(mike, Queue1), ....</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这不是一种好的做法，由于用户 ——</p><p>需要知道queue代表一个列表</p><p>实现者不能改变队列内部所指代的含义(这里他们可能需要在后面提供该模块一个更好的版本)。 更好地实现应该是:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-module(queue).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([new/0, add/2, fetch/1]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add(Item, Q) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lists:append(Q, [Item]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([H|T]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, H, T};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    empty.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在我们可以这样写:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">NewQ = queue:new(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Queue1 = queue:add(joe, NewQ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Queue2 = queue:add(mike, Queue1), ...</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是一个更好的实现并且修复了之前的问题。现在假设用户需要知道队列的长度，他们将会尝试这样写:<!-- -->[source,]</p><p>Len = length(Queue) % Don’t do this
所以他们知道queue代表一个列表。同上，这也不是一个好的实现并且会导致代码难于维护和理解。如果需要知道queue的长度，就必须在模块中添加一个length函数，这样:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-module(queue).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([new/0, add/2, fetch/1, len/1]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new() -&gt; [].</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add(Item, Q) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lists:append(Q, [Item]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([H|T]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, H, T};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch([]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    empty.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">len(Q) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    length(Q).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在，用户可以调用queue:len(Queue)来代替。 这里我们说我们已经抽象出了queue所有的细节(queue实际上是所谓的抽象数据结构)。</p><p>为何我们会遇到这些问题？抽象出内部细节的实践使得我们可以无须修改调用这些函数的模块而仅仅改变其实现细节。所以，一个更好的实现如下:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-module(queue).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([new/0, add/2, fetch/1, len/1]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {[],[]}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add(Item, {X,Y}) -&gt; % Faster addition of elements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {[Item|X], Y}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch({X, [H|T]}) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, H, {X,T}};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch({[], []) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    empty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fetch({X, []) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    % Perform this heavy computation only sometimes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fetch({[],lists:reverse(X)}).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">len({X,Y}) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    length(X) + length(Y).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="使代码尽可能具有确定性">使代码尽可能具有确定性<a class="hash-link" href="#使代码尽可能具有确定性" title="Direct link to heading">​</a></h4><p>具有确定性的程序是指无论运行多少次其运行的方式总是相同的。不确定的程序可能每次运行都传回不同的结果。为了调试方便，尽可能使代码确定是一个好的选择。这样可以是错误可再现。</p><p>例如，假设一个进程需要启动5个并发的进程，然后检查它们是否正常启动，进一步假设这5个进程启动的顺序对程序执行没有影响。</p><p>我们可以选择同时启动5个进程然后检查它们是否全部正确启动，但是每次启动其中一个并在启动下一个前检查其正确性将是更好的做法。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要做防御性编程">不要做“防御性”编程<a class="hash-link" href="#不要做防御性编程" title="Direct link to heading">​</a></h4><p>防御性编程是指程序员不“信任”他们所编写系统对于该部分的输入数据。通常我们不应为了正确性而测试输入数据。编写系统中大部分代码时应假设输入数据是正确的。只有少量代码应对数据进行正确性检测。这(检测)通常应在首次进入系统是完成，一旦数据在进入系统是通过检测，之后我们应假设它们是正确的。 例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%% Args: Option is all|normal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get_server_usage_info(Option, AsciiPid) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pid = list_to_pid(AsciiPid),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case Option of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        all -&gt; get_all_info(Pid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        normal -&gt; get_normal_info(Pid)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当Option的值不是normal或者all时函数将会崩溃，并且它应该这样做。调用者需要保证正确的输入。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="通过设备驱动分离硬件接口">通过设备驱动分离硬件接口<a class="hash-link" href="#通过设备驱动分离硬件接口" title="Direct link to heading">​</a></h4><p>应该通过使用设备驱动来分离硬件和系统。设备驱动应实现硬件接口使得硬件设备就像Erlang进程一样。 硬件应像普通Erlang进程一样接收和发送Erlang消息并且在发生错误时以传统方式响应。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="以相同的函数做执行和撤销操作">以相同的函数做“执行”和“撤销”操作<a class="hash-link" href="#以相同的函数做执行和撤销操作" title="Direct link to heading">​</a></h4><p>假设我们的程序打开了一个文件，在对文件进行操作后关闭它。代码可能是这样:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">do_something_with(File) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case file:open(File, read) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {ok, Stream} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doit(Stream),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            file:close(Stream); % The correct solution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Error -&gt; Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意打开文件(file:open)和关闭文件(file:close)在运行时的对称性。下面的解决方法难以跟踪且未显示说明哪个文件被关闭。请不要写这样的代码:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">do_something_with(File) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case file:open(File, read) of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {ok, Stream} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doit(Stream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Error -&gt; Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doit(Stream) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    func234(_,Stream,_).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func234(_, Stream, _) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file:close(Stream). %% Don’t do this</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="错误处理">错误处理<a class="hash-link" href="#错误处理" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="分离错误处理和普通代码">分离错误处理和普通代码<a class="hash-link" href="#分离错误处理和普通代码" title="Direct link to heading">​</a></h4><p>不要使被设计用来处理异常的代码把正常代码弄乱。尽可能使你的程序处理正常情况。如果处理正常情况的程序出错，进程应尽量报告错误信息并崩溃。不要试图修复错误然后继续。错误应该在不同的进程中处理(参见15页:每个进程应该仅扮演一种角色)。</p><p>错误恢复代码和(处理)正常情况的代码清晰的分离可以大大简化系统的整体设计。</p><p>当检测到软硬件出错时产生的错误日志将在后面用来诊断和修正错误。应该保留进程中任何有用信息的永久记录。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="确定错误核心">确定错误核心<a class="hash-link" href="#确定错误核心" title="Direct link to heading">​</a></h4><p>系统设计的一个基本要素是系统中哪部分需要被修正哪部分无需修正。</p><p>鉴于并不要求所有的用户程序是正确的，在传统的操作系统设计中内核是被假设并且必须正确的。如果用户程序运行失败将仅仅与发生失败的应用程序有关并且不应影响到系统作为整体的一致性。</p><p>系统设计的第一部分必须确保这部分系统一定是正确的；我们称此为错误内核。通常错误内核某种存储硬件状态的实时本地内存数据库。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="进程服务器和消息">进程、服务器和消息<a class="hash-link" href="#进程服务器和消息" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="在一个模块中实现进程">在一个模块中实现进程<a class="hash-link" href="#在一个模块中实现进程" title="Direct link to heading">​</a></h4><p>实现单独进程的代码应该包含在一个模块中。一个进程可以调用任何库中的运行时，但是进程的”顶层循环“(top loop)应包含在一个单独的模块中。进程的顶层循环代码不应被分割在几个模块中</p><p>—— 这将使控制流极其难以理解。这并不意味着开发者不能使用通用的服务器库，这些(库)是用来组织控制流的。</p><p>相反，对于不超过一种进程的代码应该在一个模块中实现。包含不同进程代码的模块非常难以理解。每个独立进程的代码应该被分割在不同模块中。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="使用进程组织系统">使用进程组织系统<a class="hash-link" href="#使用进程组织系统" title="Direct link to heading">​</a></h4><p>进程是系统基本的组织元素。然而，当可以使用一个函数处理(问题)的时候不要用进程和消息传递。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="已注册进程">已注册进程<a class="hash-link" href="#已注册进程" title="Direct link to heading">​</a></h4><p>注册进程的名称应保持和模块名相同。这样更容易查找进程代码。 应仅注册长期存在的进程。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="在系统中分配并行进程给一个真正并发的活动">在系统中分配并行进程给一个真正并发的活动<a class="hash-link" href="#在系统中分配并行进程给一个真正并发的活动" title="Direct link to heading">​</a></h4><p>决定使用顺序进程还是并行进程应由要解决问题的内部结构来决定。主要规则是:</p><p>“使用一个并行进程来模拟现实中一个真正并发的活动” 如果在并行进程和现实中并行活动的数量间存在一对一映射关系，程序会易于理解。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="每个进程应只有一种角色">每个进程应只有一种“角色”<a class="hash-link" href="#每个进程应只有一种角色" title="Direct link to heading">​</a></h4><p>系统中的进程可以有不同的角色，比如在客户端-服务器模型中。 一个进程应尽可能只有一种角色，比如它可以是一个客户端或者一个服务器，但不能是两者的结合。 进程可能扮演的其他角色如下:</p><ul><li><p>监督者:监视其它进程并在它们失败时重启。</p></li><li><p>工作者:一个普通的工作进程(可以有错误)。</p></li><li><p>信任的工作者:不允许有错误。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_nANs" id="在任何可能的地方对服务器和协议处理使用通用函数">在任何可能的地方对服务器和协议处理使用通用函数<a class="hash-link" href="#在任何可能的地方对服务器和协议处理使用通用函数" title="Direct link to heading">​</a></h4><p>在很多环境下使用如标准库中实现的通用服务器这类的通用服务器程序都是不错的选择。坚持使用通用服务器组成的小集合会大大简化系统整体结构。 这对于系统中大部分协议处理软件也是同样的。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="标记消息">标记消息<a class="hash-link" href="#标记消息" title="Direct link to heading">​</a></h4><p>所有的消息都应被标记。这样做可以弱化接收消息顺序的重要性同时使新消息的实现更容易。 不要这样写你的程序:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">loop(State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {Mod, Funcs, Args} -&gt; % Don’t do this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            apply(Mod, Funcs, Args},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop(State)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>新消息{get_status_info, From, Option} 如果被放置在{Mod, Func, Args}之后会引起冲突。</p><p>如果消息是同步的，返回消息应该用描述返回消息的新原子标记。例如:如果新到来的消息用get_status_info标记，返回消息可以标记为status_info。使用不同标记的原因之一是使得调试更容易。 以下是一个好的解决方案:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">loop(State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {execute, Mod, Funcs, Args} -&gt; % Use a tagged message.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            apply(Mod, Funcs, Args},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop(State);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {get_status_info, From, Option} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            From ! {status_info, get_status_info(Option, State)},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop(State);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="flush-unknown-messages">Flush unknown messages<a class="hash-link" href="#flush-unknown-messages" title="Direct link to heading">​</a></h4><p>每个服务器在接收(receive)声明的最后一条都应有一个“其他”选项。这样可以避免填充到消息队列。例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">main_loop() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {msg1, Msg1} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            main_loop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {msg2, Msg2} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            main_loop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Other -&gt; % Flushes the message queue.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error_logger:error_msg(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Error: Process ~w got unknown msg ~w~n.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                [self(), Other]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            main_loop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="编写尾递归tail-recursive的服务器">编写尾递归(tail-recursive)的服务器<a class="hash-link" href="#编写尾递归tail-recursive的服务器" title="Direct link to heading">​</a></h4><p>所有服务器必须是尾递归的，否则服务器将会耗尽内存。 不要这样编码:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">loop() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {msg1, Msg1} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Other -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error_logger:log({error, {process_got_other, self(), Other}}),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    io:format(&quot;Server going down&quot;). % Don’t do this!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    % This is NOT tail-recursive</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面是正确的解决方案:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">loop() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {msg1, Msg1} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            io:format(&quot;Server going down&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Other -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            error_logger:log({error, {process_got_other, self(), Other}}),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            loop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end. % This is tail-recursive</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果你使用了某些服务器库，例如generic，你可以成功避免这些问题。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="接口函数">接口函数<a class="hash-link" href="#接口函数" title="Direct link to heading">​</a></h4><p>无论何时尽可能对接口使用函数，避免直接发送消息。将消息传递归纳成接口函数。有些情况下你不能这么做。 消息协议属于内部信息，应对其他模块隐藏。 一个接口函数的例子如下:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-module(fileserver).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([start/0, stop/0, open_file/1, ...]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">open_file(FileName) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fileserver ! {open_file_request, FileName},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    receive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {open_file_response, Result} -&gt; Result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="超时">超时<a class="hash-link" href="#超时" title="Direct link to heading">​</a></h4><p>在receive 声明中使用after要谨慎。确保在消息到来之后你会处理这种情况。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="捕捉退出信号">捕捉退出(信号)<a class="hash-link" href="#捕捉退出信号" title="Direct link to heading">​</a></h4><p>只有少数进程应该捕捉退出信号。进程或者应该捕捉退出信号或者不该。(fuck!) 通常捕捉退出信号不是一个好的实现。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="各种erlang特殊约定">各种Erlang特殊约定<a class="hash-link" href="#各种erlang特殊约定" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="使用记录作为数据结构要素">使用记录作为数据结构要素<a class="hash-link" href="#使用记录作为数据结构要素" title="Direct link to heading">​</a></h4><p>使用记录作为数据结构要素。Erlang中的记录是在版本4.3以后引入的一种带标记的元组。类似于C中的结构体(struct)或Pascal中的记录(record)。</p><p>如果记录将要在多个模块中使用，应定义在这些模块包含的一个头文件(使用suffix.hrl)里。如果仅在一个模块中使用，那么它应定义在这个模块的开始位置。 Erlang中记录的特点可以用来确保模块间数据结构的一致性，并因此应在接口函数中用以在模块间传递数据。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="使用选择器和构造器">使用选择器和构造器<a class="hash-link" href="#使用选择器和构造器" title="Direct link to heading">​</a></h4><p>记录的特征提供了选择器和构造器来管理记录的实例。不要使用匹配显式地假设记录是一个元组。例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">demo() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P = #person{name = &quot;Joe&quot;, age = 29},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#person{name = Name1} = P,% Use matching, or...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name2 = P#person.name. % use the selector like this.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>不要这样写:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">demo() -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P = #person{name = &quot;Joe&quot;, age = 29},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{person, Name, _Age, _Phone, _Misc} = P. % Don’t do this</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="使用已标记的返回值">使用已标记的返回值<a class="hash-link" href="#使用已标记的返回值" title="Direct link to heading">​</a></h4><p>使用已标记的返回值。 不要这样写程序:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, [{Key, Value}|_Tail]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Value; %% Don’t return untagged values!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, [{_WrongKey, _WrongValue} | Tail]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keysearch(Key, Tail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, []) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    false.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{Key, Value}不能包含非真值(false)。 下面是正确的方法:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, [{Key, Value}|_Tail]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {value, Value}; %% Correct. Return a tagged value.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, [{_WrongKey, _WrongValue} | Tail]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keysearch(Key, Tail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keysearch(Key, []) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    false.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="使用catch和throw时要格外小心">使用catch和throw时要格外小心<a class="hash-link" href="#使用catch和throw时要格外小心" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">不要使用catch和throw除非你非常清楚你在做什么！尽可能少使用put和get。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">可以通过引入新的参数重写使用进程字典的函数。</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如:
不要这样写:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">tokenize([H|T]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tokenize([]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case get_characters_from_device(get(device)) of % Don’t use get/1!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eof -&gt; [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {value, Chars} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tokenize(Chars)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正确的写法是:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">tokenize(_Device, [H|T]) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tokenize(Device, []) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case get_characters_from_device(Device) of % This is better</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eof -&gt; [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {value, Chars} -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tokenize(Device, Chars)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用get和put将会使函数在不同情况下由相同的输入产生不同的行为。由于其不确定性使得代码难以阅读。不仅是其参数，还有进程字典使得使用了get和put的函数在调试时更加复杂。Erlang中大部分的运行时错误(例如bad_match)包含了参数，却并不包括进程字典。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要使用import">不要使用import<a class="hash-link" href="#不要使用import" title="Direct link to heading">​</a></h4><p>不要使用-import，由于你不能直接看到函数在哪个模块中定义，这样做使得代码难以阅读。使用exref(交叉引用工具)来查找模块依赖。</p><p>8.6. 导出函数
区分函数被导出的原因。导出函数通常有以下几点原因(例如):</p><p>它是模块的用户接口 它是其他模块的接口函数 它被apply, spawn等调用，但仅仅在该模块中调用。 使用不同的-export分组并对其作相应注释。例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%% user interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([help/0, start/0, stop/0, info/1]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% intermodule exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([make_pid/1, make_pid/3]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([process_abbrevs/0, print_info/5]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% exports for use within module only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-export([init/1, info_log_impl/1]).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="特殊的词法和风格约定">特殊的词法和风格约定<a class="hash-link" href="#特殊的词法和风格约定" title="Direct link to heading">​</a></h3><p>###不要写深度嵌套的代码 </p><p>嵌套代码将case/if/receive声明放在其它case/if/receive声明中。编写深度嵌套的代码不是好的编程风格 —— 向右超过一页的代码将很容易变得难以阅读。尽量限制你的代码在两级缩进以内。可以通过将函数分割成更小的函数来达到此目的。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要写过大的模块">不要写过大的模块<a class="hash-link" href="#不要写过大的模块" title="Direct link to heading">​</a></h4><p>一个模块不应超过400行源代码。几个小模块要比一个庞大的模块更好。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要写很长的函数">不要写很长的函数<a class="hash-link" href="#不要写很长的函数" title="Direct link to heading">​</a></h4><p>不要写超过15到20行的函数。把大的函数分割成若干小函数。也不要试图写很长的一行来解决问题。（有人为了达到行数少的目的，会把本来几行的代码写在一行。—— 译者注）</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要使一行代码过长">不要使一行代码过长<a class="hash-link" href="#不要使一行代码过长" title="Direct link to heading">​</a></h4><p>不要写很长的行。一行代码应不超过80个字符(这将恰好填满一张A4纸)。 在Erlang 4.3之后的版本中，字符串常量会自动连接。例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">io:format(&quot;Name: ~s, Age: ~w, Phone: ~w ~n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Dictionary: ~w.~n&quot;, [Name, Age, Phone, Dict])</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="变量名">变量名<a class="hash-link" href="#变量名" title="Direct link to heading">​</a></h4><p>选择有意义的变量名 —— 这并不容易。 如果一个变量名包含几个单词，使用下划线()或大写首字母来来分隔(标记)它们。例如:My_variable 或MyVariable。 避免使用 &quot;&quot;(下划线)来表示匿名变量(don’t care variable)(可以匹配任意内容的变量 —— 译者注) —— 使用下划线开头的变量名来代替，例如:_Name①。如果后面需要使用该变量，只需要移除开头的下划线。在查找哪个下划线需要被替换时不会遇到麻烦同时也使代码易于阅读。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="函数名">函数名<a class="hash-link" href="#函数名" title="Direct link to heading">​</a></h4><p>函数名必须和它所做的事情保持一致。它应返回函数名所隐含的参数(返回值 —— 译者注)。当你阅读它时不会感到惊讶。对常见的函数使用约定俗成的名称(例如:start, stop, init, main<em>loop)。 不同模块中解决相同问题的函数应使用相同的名称。例如:module_info()。 糟糕的函数名是常见的编程误区之一 —— 选择好的函数名非常困难。 在编写大量不同函数时一些常用的命名方式大有裨益。例如:前缀&quot;is</em>&quot;可以用来表示函数是一个返回true或false的问题。</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">is_...() -&gt; true | false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">check_...() -&gt; {ok, ...} | {error, ...}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="模块名">模块名<a class="hash-link" href="#模块名" title="Direct link to heading">​</a></h4><p>Erlang的模块结构是平面的（没有模块在其他模块中定义）。然而，我们常常需要模拟出层级模块的结构。可以通过对相关模块使用相同前缀名称来解决这一问题。 例如，我们使用5个不同的模块来处理一个ISDN问题。这些模块可以这样命名:</p><p>isdn<em>init
isdn_partb
isdn</em>...</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="以统一的方式格式化代码">以统一的方式格式化代码<a class="hash-link" href="#以统一的方式格式化代码" title="Direct link to heading">​</a></h4><p>统一的代码风格能够帮助你和其他人理解代码。不同的人在使用缩进和空格时有不同的风格和习惯。</p><p>例如你可能会在写元组时用一个逗号分隔开两个元素: {12, 23, 45}</p><p>其他人可能会在逗号后面跟一个空格:</p><p>{12, 23, 45}</p><p>一旦你适应了一种风格就坚持使用它。</p><p>在一些大的项目中，应使用统一的编码风格。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="文档化代码">文档化代码<a class="hash-link" href="#文档化代码" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="注明代码归属holy-fucking-shit">注明代码归属(HOLY FUCKING SHIT)<a class="hash-link" href="#注明代码归属holy-fucking-shit" title="Direct link to heading">​</a></h4><p>你应在模块开头清楚地注明代码的归属。说明代码内容来自何处(指作者和其中思路，原文使用ideas简直是……简直了…… —— 译者注) —— 如果来源于其他代码请注明来自何处并注明其作者。 不要窃取代码(很多人都做过的事 —— 译者注) —— 窃取代码指使用了其他模块的代码而忘记标明原模块的作者。 以下是写有用的例子:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">-revision(’Revision: 1.14 ’).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-created(’Date: 1995/01/01 11:21:11 ’).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-created_by(’eklas@erlang’).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-modified(’Date: 1995/01/05 13:04:07 ’).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-modified_by(’mbj@erlang’).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="提供代码所引用的细节信息">提供代码所引用的细节信息<a class="hash-link" href="#提供代码所引用的细节信息" title="Direct link to heading">​</a></h4><p>在代码中提供相关引用文档(的细节)来帮助理解代码。例如:如果代码实现了某些通信协议或硬件接口则应给出引用文档中的确切页码。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="在文档中列出所有错误">在文档中列出所有错误<a class="hash-link" href="#在文档中列出所有错误" title="Direct link to heading">​</a></h4><p>用英文描述(日常所使用的语言，不限于英文——译者注)将所有错误信息列在一起用来说明在不同文档中他们的具体含义。 这里的错误指系统检测出的错误信息。 在你的程序中检测出的错误信息的地方使用错误日志(error logger)，例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">error_logger:error_msg(Format, {Descriptor, Arg1, Arg2, ....})</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时确保{Descriptor, Arg1,…​}所在行存在于错误信息描述的文档中。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="列出消息传递中数据结构的所有原则">列出消息传递中数据结构的所有原则<a class="hash-link" href="#列出消息传递中数据结构的所有原则" title="Direct link to heading">​</a></h4><p>使用标记的元组作为系统中不同部分发送消息时其数据结构的原则。 Erlang中记录的特性(在版本4.3之后引入的)可以用来确保不同模块数据结构的一致性。 应在一份文档中用英文描述所有的数据结构(参见32页的“消息描述”)。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="注释">注释<a class="hash-link" href="#注释" title="Direct link to heading">​</a></h4><p>注释应该清晰且言简意赅，同时避免不必要的罗嗦。确保注释和代码本身在时间上保持同步。检查添加到代码说明的注释。用英文写注释。 模块的注释不应包含缩进并且以三个百分号开头(%%%)(参见29页“文件首部，描述”)。 函数的注释也不应包含缩进并且以两个百分号开头(%%)(参见27也“注释每个函数”)。 Erlang代码中的注释用一个百分号开头(%)。如果某一行只有注释，应和Erlang代码保持相同缩进。注释应放在相应代码之上。如果注释能和相应代码在同一行将会更好。</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%% Comment about function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">some_useful_functions(UsefulArgugument) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">another_functions(UsefulArgugument), % Comment at end of line</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">% Comment about complicated_stmnt at the same level of indentation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">complicated_stmnt,</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="注释每个函数">注释每个函数<a class="hash-link" href="#注释每个函数" title="Direct link to heading">​</a></h4><p>对说明有几点很重要:</p><p>函数的目标</p><p>合法输入的范围。指参数的数据结构及其含义</p><p>输出参数的范围。指返回值的所有可能数据结构及其含义</p><p>如果函数实现了较复杂的算法，在注释中描述该算法</p><p>可能产生错误的原因以及由exit/1, throw/1或任何非显式运行时错误产生的退出信号 函数的任何副作用 例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%%----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Function: get_server_statistics/2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Purpose: Get various information from a process.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Args: Option is normal|all.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Returns: A list of {Key, Value}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% or {error, Reason} (if the process is dead)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">get_server_statistics(Option, Pid) when pid(Pid) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="数据结构">数据结构<a class="hash-link" href="#数据结构" title="Direct link to heading">​</a></h4><p>记录的定义和其纯文本描述放在一起。例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%% File: my_data_structures.h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Data Type: person</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% where:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% name: A string (default is undefined).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% age: An integer (default is undefined).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% phone: A list of integers (default is []).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% dict: A dictionary containing various information about the person.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% A {Key, Value} list (default is the empty list).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%----------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-record(person, {name, age, phone = [], dict = []}).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="文件头版权信息">文件头，版权信息<a class="hash-link" href="#文件头版权信息" title="Direct link to heading">​</a></h4><p>每个源文件应由版权信息开头，例如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Copyright Ericsson Telecom AB 1996</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% All rights reserved. No part of this computer programs(s) may be</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% used, reproduced,stored in any retrieval system, or transmitted,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% in any form or by any means, electronic, mechanical, photocopying,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% recording, or otherwise without prior written permission of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Ericsson Telecom AB.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="文件头版本历史">文件头，版本历史<a class="hash-link" href="#文件头版本历史" title="Direct link to heading">​</a></h4><p>每个源文件应包含其修改这及其修改内容的版本历史信息。</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Revision History</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Rev PA1 Date 960230 Author Fred Bloggs (ETXXXXX)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Intitial pre release. Functions for adding and deleting foobars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% are incomplete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Rev A Date 960230 Author Johanna Johansson (ETXYYY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Added functions for adding and deleting foobars and changed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% data structures of foobars to allow for the needs of the Baz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% signalling system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="文件头-描述">文件头， 描述<a class="hash-link" href="#文件头-描述" title="Direct link to heading">​</a></h4><p>文件开头应包含对该模块的简介和所有导出函数的简要说明。</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Description module foobar_data_manipulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Foobars are the basic elements in the Baz signalling system. The</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% functions below are for manipulating that data of foobars and for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% etc etc etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% Exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% create_foobar(Parent, Type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% returns a new foobar object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%% etc etc etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%%%---------------------------------------------------------------------</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果你了解其中任何弱点、缺陷和未经过良好测试的部分，对其做特殊的说明，不要试图隐藏它们。如果代码任何地方是不完整的，都要对其作出特殊说明。增加会对将来维护代码有益的注释。即使你所写的某些模块很完善，在未来十年也可能会有其他人来修改。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="不要注释过时的代码--删掉它们">不要注释过时的代码 —— 删掉它们<a class="hash-link" href="#不要注释过时的代码--删掉它们" title="Direct link to heading">​</a></h4><p>对于过时的代码在版本历史中说明它们。版本控制系统将会起到作用。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="使用版本控制系统">使用版本控制系统<a class="hash-link" href="#使用版本控制系统" title="Direct link to heading">​</a></h3><p>任何整体的系统都应使用版本控制系统来跟踪模块，比如GIT，RCS, CVS或Clearcase。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="常见错误">常见错误<a class="hash-link" href="#常见错误" title="Direct link to heading">​</a></h3><p>编写跨度很多页的函数（参见23页“不要写长函数”）。</p><p>编写嵌套的if, receive, case（参见23页“不要写深层嵌套代码”） 编写类型糟糕的函数（参见19页“使用标记的返回值”）</p><p>函数名不能反映出它的功能（参见24页“函数名”）</p><p>无意义的变量名（参见23页“变量名”）</p><p>不必要的时候使用进程（参见14页“对系统中每个并发活动准确地使用进程”）</p><p>选择糟糕的数据类型（糟糕的陈述）</p><p>糟糕的注释或者完全没有注释（始终要说明参数和返回值）</p><p>无意识的代码</p><p>使用put和get（参见20页“谨慎地使用进程字典”） 对消息队列无控制（参见16页“Flush unknown messages”和18页“超时”）</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="所需文档">所需文档<a class="hash-link" href="#所需文档" title="Direct link to heading">​</a></h3><p>这部分描述了使用Erlang设计和维护系统时的一些系统级的文档。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="模块描述">模块描述<a class="hash-link" href="#模块描述" title="Direct link to heading">​</a></h4><p>每个模块一个章节。像下面这样包含每个模块的描述和所有的导出函数:</p><p>函数参数的数据结构</p><p>函数返回值的数据结构</p><p>函数的目的，</p><p>可能引起错误的原因和直接调用exit/1生成的退出信号，</p><p>文档格式在后面部分定义</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="消息描述">消息描述<a class="hash-link" href="#消息描述" title="Direct link to heading">​</a></h4><p>除了定义在一个模块内的其他所有进程间消息的格式。 文档格式在后面部分定义</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="进程">进程<a class="hash-link" href="#进程" title="Direct link to heading">​</a></h4><p>系统中所有注册的服务器及其接口和目的的描述。 所有动态进程及其接口的描述。 文档格式在后面部分定义</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="错误消息">错误消息<a class="hash-link" href="#错误消息" title="Direct link to heading">​</a></h4><p>错误消息的描述。 文档格式在后面部分定义</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="注解">注解:<a class="hash-link" href="#注解" title="Direct link to heading">​</a></h3><p>这里指不要使用单独的下划线表示这种可做任意匹配的变量, 例如:bad(Dog) :- bites(Dog, ). 其中的&quot;&quot;。 —— 译者注。</p><p>Erlang进程不同于操作系统进程，Erlang进程是比系统中线程更加轻量级的任务。——译者注。</p><p>尽可能不要使用进程字典，总有更好的解决方案，参见《Erlang OTP编程实战》一书。——译者注。</p><p>这种做法正符合Erlang“让其崩溃”的原则。——译者注。</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="任务调度">任务调度<a class="hash-link" href="#任务调度" title="Direct link to heading">​</a></h2><p> 任务调度就像交通管控一样，有效管控联网设备秩序的重要环节,尤其是低功耗海量联网设备场景下，有效的任务调度策略可以让海量的物联网设备从无序态进入有序态，
可以均衡的使用运营商网络资源，服务器的计算/存储资源，在不大量增加物联网建设投资的情况下，取得比较高的服务质量。
<img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/dgiot_func.png" alt="dgiot_func.png" class="img_xIgF"></p><h3 class="anchor anchorWithStickyNavbar_nANs" id="场景描述">场景描述<a class="hash-link" href="#场景描述" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------------------                                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           Group                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             |                 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             +------+--------+------------+          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             |               |            |   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           GateWay        GateWay      GateWay  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             |               |        ---+---     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       +-----+-----+       Device     |  |   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |           |         +       Di  Di  Di</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Device    SubGateWay    |            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |           |        Di            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     --+--      +---+---+              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |     |    |        |              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Di    Di  Device   Device </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               +        +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               |        |  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Di       Di   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------  </span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="分组任务">分组任务<a class="hash-link" href="#分组任务" title="Direct link to heading">​</a></h3><ul><li>单个任务通道挂载在Group上，进行工程级的任务编排与数据汇聚，</li><li>通道自动搜索多级子设备的物模型来创建工程级的指令集，单个任务进程采集指令规模目前约束在2048以内</li><li>主要应用于智能家居联动、基站区域集抄，OPC服务器，大型仓库设备状态巡检等</li></ul><h3 class="anchor anchorWithStickyNavbar_nANs" id="网关任务">网关任务<a class="hash-link" href="#网关任务" title="Direct link to heading">​</a></h3><ul><li>单个任务通道挂载在GateWay上,进行网关级的任务编排与数据汇聚，</li><li>通道自动搜索多级子设备的物模型来创建网关级的指令集，单个任务进程采集指令规模约束在2048以内</li><li>主要应用于Modbus网关、PLC网关、DTU网关、传统集中器、采集箱等</li></ul><h3 class="anchor anchorWithStickyNavbar_nANs" id="多通道任务">多通道任务<a class="hash-link" href="#多通道任务" title="Direct link to heading">​</a></h3><ul><li>多个任务通道挂载在多个Group或GateWay上,进行多通道的任务联动与数据汇聚</li><li>通过自动搜索多级子设备物模型来创建设备级的指令集, 单个任务进程采集指令规模约束在2048以内</li><li>主要应用于采用多通道采集实现设备采集成功率要求接近100%的场景，例如国网南网电力集抄成功率要求98%以上</li></ul><h3 class="anchor anchorWithStickyNavbar_nANs" id="系统容量">系统容量<a class="hash-link" href="#系统容量" title="Direct link to heading">​</a></h3><ul><li>低配单机服务器支持十万级的设备数据采集指令编排、任务调度与数据汇聚</li><li>中配单机服务器支持百万级的设备数据采集指令编排、任务调度与数据汇聚</li><li>高配单机服务器支持千万级的设备数据采集指令编排、任务调度与数据汇聚</li><li>高配集群服务器支持亿万级的设备数据采集指令编排、任务调度与数据汇聚</li></ul><h2 class="anchor anchorWithStickyNavbar_nANs" id="数据同步">数据同步<a class="hash-link" href="#数据同步" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_nANs" id="api-hook配置同步数据库-缓存">API Hook配置同步（数据库-&gt;缓存）<a class="hash-link" href="#api-hook配置同步数据库-缓存" title="Direct link to heading">​</a></h3><p>用户调用API修改parse库配置后，通API Hook同步到ets缓存，例如通道中做如下处理</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">%% 初始化池子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handle_init(State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shuwa_parse:subscribe(&lt;&lt;&quot;Device&quot;&gt;&gt;, post),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shuwa_parse:subscribe(&lt;&lt;&quot;Device/*&quot;&gt;&gt;, post),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, State}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handle_message({sync_parse, Args}, State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    %% do something </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lager:info(&quot;sync_parse ~p&quot;, [Args]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {ok, State};</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="livequery同步数据库-缓存">Livequery同步（数据库-&gt;缓存）<a class="hash-link" href="#livequery同步数据库-缓存" title="Direct link to heading">​</a></h3><p>parse库修改同步到ets缓存 <br>
parse开启livequery<br>
编辑
vim /data/shuwa_parse_server/script/config.json <br>
修改 <strong>app</strong> 下 <strong>liveQuery</strong> 添加需要同步的表 <br>
<img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/parse/livequery_config.png" class="img_xIgF"></p><p>登录获取SessionToken</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">shuwa_parse_handler:login_by_account(UserName, Password).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ok,#{&lt;&lt;&quot;sessionToken&quot;&gt;&gt; =&gt; &lt;&lt;&quot;r:af99fafcfebbcfe04770e74ca2646b11&quot;&gt;&gt;}}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>shuwa_livequery订阅Device表</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain"> shuwa_livequery:subscribe(&lt;&lt;&quot;r:af99fafcfebbcfe04770e74ca2646b11&quot;&gt;&gt;, &lt;&lt;&quot;Device&quot;&gt;&gt;, #{}),</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">handle_info({livequery, #{&lt;&lt;&quot;object&quot;&gt;&gt; := Object}}, #task{step = login} = State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {noreply, do_depploy(Object, State)};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">handle_info({livequery, _Other}, State) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {noreply, State};</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="api-hook同步数据数据库缓存--用户">API Hook同步数据（数据库+缓存 -&gt;用户）<a class="hash-link" href="#api-hook同步数据数据库缓存--用户" title="Direct link to heading">​</a></h3><p>用户查询parse库后返回过程中，DG-IOT自动同步ets缓存中的实时状态数据，解决状态不同步问题，</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="远程定位">远程定位<a class="hash-link" href="#远程定位" title="Direct link to heading">​</a></h2><div class="language-auto codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-auto codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">1&gt; observer:start().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: Could not find &#x27;wxe_driver.so&#x27; in : /XXX/XXX/XXX</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="解决"><strong>解决：</strong><a class="hash-link" href="#解决" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="1-erlang官方工具支持连接远程节点本地windows安装erlang环境命令行下启动erlang-shell">1<!-- -->.<!-- --> erlang官方工具支持连接远程节点，本地windows安装erlang环境，命令行下启动erlang shell：<a class="hash-link" href="#1-erlang官方工具支持连接远程节点本地windows安装erlang环境命令行下启动erlang-shell" title="Direct link to heading">​</a></h4><div class="language-auto codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-auto codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">    erl -name observer@local_ip -setcookie secret_cookie</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>说明：</strong><br>
<!-- -->local<!-- -->_<!-- -->ip为本地ip，secret<!-- -->_<!-- -->cookie为erlang分布式节点的配置的cookie。<br>
<!-- -->此处我们启动了一个名为observer@local<!-- -->_<!-- -->ip的节点。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="2本地启动observer">2.本地启动observer<a class="hash-link" href="#2本地启动observer" title="Direct link to heading">​</a></h4><div class="language-auto codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-auto codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">    (observer@127.0.0.1)1&gt; observer:start().</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="3连接远程节点">3.连接远程节点<a class="hash-link" href="#3连接远程节点" title="Direct link to heading">​</a></h4><p>启动observer之后，点击菜单栏的Nodes - Connect Node，输入远程节点的node name后可正常连接。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="etop">Etop<a class="hash-link" href="#etop" title="Direct link to heading">​</a></h3><p>类似top命令，查看erlang进程占用cpu、内存较高的进程  </p><p>参数：  </p><p>  node        atom       erlang node<br>
<!-- -->port        integer    The used port<br>
<!-- -->accumulate  boolean    If true execution time is accumulated<br>
<!-- -->lines       integer    Number of displayed processes<br>
<!-- -->interval    integer    Display update interval in secs<br>
<!-- -->sort        runtime | reductions | memory | msg<!-- -->_<!-- -->q<br>
<!-- -->output      graphical | text<br>
<!-- -->tracing     on | off <br>
<!-- -->setcookie   string    </p><p>使用举例：</p><p>1<!-- -->.<!-- --> 找出cpu占用最高的进程，图形界面输出，每10秒更新一次  </p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; spawn(fun() -&gt; etop:start([{interval,10}, {sort, runtime}]) end).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; etop:stop().</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2<!-- -->.<!-- --> 找出内存占用较高进程, 输出进程的数量为20，文本形式输出</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; spawn(fun() -&gt; etop:start([{output, text}, {lines, 20},  {sort, memory}]) end).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; etop:stop().</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3<!-- -->.<!-- --> 查看远程节点etop：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain"> &gt; erl -name abc@192.168.17.102 -hidden -s etop -output text -sort memory -lines 20 -node &#x27;test@192.168.17.102&#x27; -setcookie mycookie123</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; erl -name abc@192.168.17.102 -hidden</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; etop:start([{node,&#x27;test@192.168.17.102&#x27;}, {setcookie, &quot;mycookie123&quot;}, {output, text}, {lines, 20},  {sort, memory}])</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>rpc:call  </p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; erl -name abc@192.168.17.102 -setcookie mycookie123 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; rpc:call(&#x27;test@192.168.17.102&#x27;, etop, start, [[{output, text}, {lines, 20},  {sort, memory}]]).</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="eprof">eprof<a class="hash-link" href="#eprof" title="Direct link to heading">​</a></h3><p>假设我们使用etop查到了cpu占用时间较多的进程id，那么可以使用eprof进行进一步的分析.  </p><p>基本用法：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:start().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:profile([pid(x,x,x)]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:stop_profiling().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:analyze().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:stop().</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:start_profiling([regNames], {gen, call, 4}).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:stop_profiling().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:analyze().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; eprof:stop().</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>regNames可以填写进程的注册名, {gen, call, 4}表示只记录gen:call/4这个函数</p><p>analyze结果示例：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">****** Process &lt;0.60.0&gt;    -- 100.00 % of profiled time *** </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FUNCTION                 CALLS      %  TIME  [uS / CALLS]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------                 -----    ---  ----  [----------]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen:call/4                   2   0.00     0  [      0.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen:do_call/4                2   0.22     1  [      0.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_server:call/2            2   0.44     2  [      1.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dbutil:i_connect/1           2   0.66     3  [      1.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen:call/3                   2   0.66     3  [      1.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource_pool:get/1          2   0.66     3  [      1.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mvar:modify/2                2   0.66     3  [      1.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_server:decode_msg/8      4   0.88     4  [      1.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">erlang:monitor/2             2   0.88     4  [      2.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">erlang:demonitor/2           2   1.33     6  [      3.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_server:handle_msg/5      4   1.55     7  [      1.75]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myserver:handle_call/3       4   1.77     8  [      2.00]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_server:loop/6            4   1.99     9  [      2.25]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">erlang:send/3                2   3.76    17  [      8.50]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_server:reply/2           4  84.51   382  [     95.50]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="fprof">fprof<a class="hash-link" href="#fprof" title="Direct link to heading">​</a></h3><p>fprof类似eprof，但是会把详细信息存储到文件中，方便数据统计分析。</p><p>只看某一函数的简单调用方法：  </p><p>1&gt; fprof:apply(Module, fun, Args).
2&gt; fprof:profile().
3&gt; fprof:analyse().</p><p>实际上在执行的时候，fprof:apply/3前后会自动添加trace(<!-- -->[<!-- -->start, ...<!-- -->]<!-- -->) 和 trace(stop).</p><p>完整的写法是：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; fprof:trace([start, {file, &quot;./fprof.trace&quot;}, {procs, PidSpec}]).  %% 或者可以trace多个Pid，[PidSpec]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; fprof:trace(stop).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; fprof:profile({file, &quot;./fprof.trace&quot;}).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; fprof:analyse([{dest, &quot;fprof.analysis&quot;},{sort,own}]).  %% 详细参数见： http://www.erlang.org/doc/man/fprof.html#analyse-2</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结果示例：</p><div class="language-plain codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-plain codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">1&gt; fprof:apply(lists, reverse, [&quot;abcdef&quot;]).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;fedcba&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2&gt; fprof:profile().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading trace data...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End of trace!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3&gt; fprof:analyse().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing data...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating output...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%% Analysis results:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{  analysis_options,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [{callers, true},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {sort, acc},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {totals, false},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {details, true}]}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%                                               CNT       ACC       OWN        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{ totals,                                        3,    0.027,    0.027}].  %%% CNT是trace过程中函数调用的总数,ACC是整个trace的时间,OWN为函数执行时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%                                               CNT       ACC       OWN        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{ &quot;&lt;0.33.0&gt;&quot;,                                    3,undefined,    0.027}].   %%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{[{undefined,                                     0,    0.027,    0.019}],     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { {fprof,apply_start_stop,4},                    0,    0.027,    0.019},     %</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [{{lists,reverse,1},                             1,    0.008,    0.005},      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {suspend,                                       1,    0.000,    0.000}]}.    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{[{{fprof,apply_start_stop,4},                    1,    0.008,    0.005}],     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { {lists,reverse,1},                             1,    0.008,    0.005},     %</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [{{lists,reverse,2},                             1,    0.003,    0.003}]}.    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{[{{lists,reverse,1},                             1,    0.003,    0.003}],     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { {lists,reverse,2},                             1,    0.003,    0.003},     %</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [ ]}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{[ ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { undefined,                                     0,    0.000,    0.000},     %</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [{{fprof,apply_start_stop,4},                    0,    0.027,    0.019}]}.    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{[{{fprof,apply_start_stop,4},                    1,    0.000,    0.000}],     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> { suspend,                                       1,    0.000,    0.000},     %</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> [ ]}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Done!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ok</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>%是一种标记，每一个“段落”中，%表示被调用的函数主体，%以上为调用它的函数，%以下为它调用的函数。“段落”中的CNT列表示被调用次数，Acc表示包括%之上的函数在内所花费的时间，own表示不包括%之上的函数所用的时间。</p><p>suspend表示进程挂起。  </p><p>也可以将fprof这类工具卸载想监控的代码前后。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="cprof">cprof<a class="hash-link" href="#cprof" title="Direct link to heading">​</a></h3><p>用于统计一个函数中的每个函数的调用次数。相较于eprof和fprof，cprof对性能影响很小，官方说大约10%  </p><p>使用举例（引自官网）</p><p>1&gt; cprof:start(),R=calendar:day<!-- -->_<!-- -->of<!-- -->_<!-- -->the<!-- -->_<!-- -->week(1896,4,27),cprof:pause(),R.
1
2&gt; cprof:analyse(calendar).
{calendar,9,
<!-- -->[<!-- -->{{calendar,df,2},1},
{{calendar,dm,1},1},
{{calendar,dy,1},1},
{{calendar,last<!-- -->_<!-- -->day<!-- -->_<!-- -->of<!-- -->_<!-- -->the<!-- -->_<!-- -->month1,2},1},
{{calendar,last<!-- -->_<!-- -->day<!-- -->_<!-- -->of<!-- -->_<!-- -->the<!-- -->_<!-- -->month,2},1},
{{calendar,is<!-- -->_<!-- -->leap<!-- -->_<!-- -->year1,1},1},
{{calendar,is<!-- -->_<!-- -->leap<!-- -->_<!-- -->year,1},1},
{{calendar,day<!-- -->_<!-- -->of<!-- -->_<!-- -->the<!-- -->_<!-- -->week,3},1},
{{calendar,date<!-- -->_<!-- -->to<!-- -->_<!-- -->gregorian<!-- -->_<!-- -->days,3},1}<!-- -->]<!-- -->}
3&gt; cprof:stop().
3271</p><p>该示例表明day<!-- -->_<!-- -->of<!-- -->_<!-- -->the<!-- -->_<!-- -->week这个函数需要调用9个函数完成计算。</p><p>同样cprof可以嵌入代码中。  </p><h3 class="anchor anchorWithStickyNavbar_nANs" id="webtool">Webtool<a class="hash-link" href="#webtool" title="Direct link to heading">​</a></h3><p>webtool:start().  %% 默认端口8888, http://localhost:8888/</p><p>appmon:start(). %% 查看application树  </p><p>pman:start().  %%监控进程  </p><p>tv:start().  %% ets &amp; mnesia</p><p>toolbar:start().  %% 包含了上面几个</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="规则引擎">规则引擎<a class="hash-link" href="#规则引擎" title="Direct link to heading">​</a></h2><p>EMQ X Rule Engine (以下简称规则引擎) 用于配置 EMQ X 消息流与设备事件的处理、响应规则。规则引擎不仅提供了清晰、灵活的 &quot;配置式&quot; 的业务集成方案，简化了业务开发流程，提升用户易用性，降低业务系统与 EMQ X 的耦合度；也为 EMQ X 的私有功能定制提供了一个更优秀的基础架构。</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/rule-engine/rule-engine.jpg" alt="rule-engine.jpg" class="img_xIgF"></p><p>EMQ X 在 <strong>消息发布或事件触发</strong> 时将触发规则引擎，满足触发条件的规则将执行各自的 SQL 语句筛选并处理消息和事件的上下文信息。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="emq-x-规则引擎快速入门">EMQ X 规则引擎快速入门<a class="hash-link" href="#emq-x-规则引擎快速入门" title="Direct link to heading">​</a></h3><p>此处包含规则引擎的简介与实战，演示使用规则引擎结合华为云 RDS 上的 MySQL 服务，进行物联网 MQTT 设备在线状态记录、消息存储入库。</p><p>从本视频中可以快速了解规则引擎解决的问题和基础使用方法。</p><iframe src="//player.bilibili.com/player.html?aid=927036281&amp;bvid=BV19T4y1w7Nj&amp;cid=233977851&amp;page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h3 class="anchor anchorWithStickyNavbar_nANs" id="消息发布">消息发布<a class="hash-link" href="#消息发布" title="Direct link to heading">​</a></h3><p>规则引擎借助响应动作可将特定主题的消息处理结果存储到数据库，发送到 HTTP Server，转发到消息队列 Kafka 或 RabbitMQ，重新发布到新的主题甚至是另一个 Broker 集群中，每个规则可以配置多个响应动作。</p><p>选择发布到 t/# 主题的消息，并筛选出全部字段：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>选择发布到 t/a 主题的消息，并从 JSON 格式的消息内容中筛选出 &quot;x&quot; 字段：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/a&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="事件触发">事件触发<a class="hash-link" href="#事件触发" title="Direct link to heading">​</a></h3><p>规则引擎使用 <strong>$events/</strong> 开头的虚拟主题（<strong>事件主题</strong>）处理 EMQ X 内置事件，内置事件提供更精细的消息控制和客户端动作处理能力，可用在 QoS 1 QoS 2 的消息抵达记录、设备上下线记录等业务中。</p><p>选择客户端连接事件，筛选 Username 为 &#x27;emqx&#x27; 的设备并获取连接信息：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> clientid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> connected_at </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/client_connected&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> username </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;emqx&#x27;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>规则引擎数据和 SQL 语句格式，<a href="#event-topics">事件主题</a> 列表详细教程参见 <a href="#rule-sql">SQL 手册</a>。</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="最小规则">最小规则<a class="hash-link" href="#最小规则" title="Direct link to heading">​</a></h3><p>规则描述了 <strong>数据从哪里来</strong>、<strong>如何筛选并处理数据</strong>、<strong>处理结果到哪里去</strong> 三个配置，即一条可用的规则包含三个要素：</p><ul><li>触发事件：规则通过事件触发，触发时事件给规则注入事件的上下文信息（数据源），通过 SQL 的 FROM 子句指定事件类型；</li><li>处理规则（SQL）：使用 SELECT 子句 和 WHERE 子句以及内置处理函数， 从上下文信息中过滤和处理数据；</li><li>响应动作：如果有处理结果输出，规则将执行相应的动作，如持久化到数据库、重新发布处理后的消息、转发消息到消息队列等。一条规则可以配置多个响应动作。</li></ul><p>如图所示是一条简单的规则，该条规则用于处理 <strong>消息发布</strong> 时的数据，将全部主题消息的 <code>msg</code> 字段，消息 <code>topic</code> 、<code>qos</code> 筛选出来，发送到 Web Server 与 /uplink 主题：</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/rule-engine/dashboard.png" alt="dashboard.png" class="img_xIgF"></p><h3 class="anchor anchorWithStickyNavbar_nANs" id="规则引擎典型应用场景举例">规则引擎典型应用场景举例<a class="hash-link" href="#规则引擎典型应用场景举例" title="Direct link to heading">​</a></h3><ul><li>动作监听：智慧家庭智能门锁开发中，门锁会因为网络、电源故障、人为破坏等原因离线导致功能异常，使用规则引擎配置监听离线事件向应用服务推送该故障信息，可以在接入层实现第一时间的故障检测的能力；</li><li>数据筛选：车辆网的卡车车队管理，车辆传感器采集并上报了大量运行数据，应用平台仅关注车速大于 40 km/h 时的数据，此场景下可以使用规则引擎对消息进行条件过滤，向业务消息队列写入满足条件的数据；</li><li>消息路由：智能计费应用中，终端设备通过不同主题区分业务类型，可通过配置规则引擎将计费业务的消息接入计费消息队列并在消息抵达设备端后发送确认通知到业务系统，非计费信息接入其他消息队列，实现业务消息路由配置；</li><li>消息编解码：其他公共协议 / 私有 TCP 协议接入、工控行业等应用场景下，可以通过规则引擎的本地处理函数（可在 EMQ X 上定制开发）做二进制 / 特殊格式消息体的编解码工作；亦可通过规则引擎的消息路由将相关消息流向外部计算资源如函数计算进行处理（可由用户自行开发处理逻辑），将消息转为业务易于处理的 JSON 格式，简化项目集成难度、提升应用快速开发交付能力。</li></ul><h3 class="anchor anchorWithStickyNavbar_nANs" id="迁移指南">迁移指南<a class="hash-link" href="#迁移指南" title="Direct link to heading">​</a></h3><p>4.0 版本中规则引擎 SQL 语法更加易用，3.x 版本中所有事件 <strong>FROM</strong> 子句后面均需要指定事件名称，4.0 以后我们引入 <strong>事件主题</strong> 概念，默认情况下 <strong>消息发布</strong> 事件不再需要指定事件名称：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## 3.x 版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 需要指定事件名称进行处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> topic </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;t/#&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 4.0 及以后版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 默认处理 message.publish 事件，FROM 后面直接填写 MQTT 主题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 上述 SQL 语句等价于:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;t/#&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## 其他事件，FROM 后面填写事件主题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/message_acked&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> topic </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;t/#&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/client_connected&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>::: tip
Dashboard 中提供了旧版 SQL 语法转换功能可以完成 SQL 升级迁移。
:::</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="规则引擎组成">规则引擎组成<a class="hash-link" href="#规则引擎组成" title="Direct link to heading">​</a></h3><p>使用 EMQ X 的规则引擎可以灵活地处理消息和事件。使用规则引擎可以方便地实现诸如将消息转换成指定格式，然后存入数据库表，或者发送到消息队列等。</p><p>与 EMQ X 规则引擎相关的概念包括: 规则(rule)、动作(action)、资源(resource) 和 资源类型(resource-type)。</p><p>规则、动作、资源的关系:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">规则: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SQL 语句,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    动作列表: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            动作1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            动作参数,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            绑定资源: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                资源配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            动作2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            动作参数,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            绑定资源: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                资源配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>规则(Rule): 规则由 SQL 语句和动作列表组成。动作列表包含一个或多个动作及其参数。</li><li>SQL 语句用于筛选或转换消息中的数据。</li><li>动作(Action) 是 SQL 语句匹配通过之后，所执行的任务。动作定义了一个针对数据的操作。
动作可以绑定资源，也可以不绑定。例如，“inspect” 动作不需要绑定资源，它只是简单打印数据内容和动作参数。而 “data_to_webserver” 动作需要绑定一个 web_hook 类型的资源，此资源中配置了 URL。</li><li>资源(Resource): 资源是通过资源类型为模板实例化出来的对象，保存了与资源相关的配置(比如数据库连接地址和端口、用户名和密码等) 和系统资源(如文件句柄，连接套接字等)。</li><li>资源类型 (Resource Type): 资源类型是资源的静态定义，描述了此类型资源需要的配置项。</li></ul><p>::: tip
动作和资源类型是由 emqx 或插件的代码提供的，不能通过 API 和 CLI 动态创建。
:::</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="sql-语句">SQL 语句<a class="hash-link" href="#sql-语句" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_nANs" id="sql-语法">SQL 语法<a class="hash-link" href="#sql-语法" title="Direct link to heading">​</a></h4><p><strong>FROM、SELECT 和 WHERE 子句:</strong></p><p>规则引擎的 SQL 语句基本格式为:</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">字段名</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">主题</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">条件</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>FROM</code> 子句将规则挂载到某个主题上</li><li><code>SELECT</code> 子句用于对数据进行变换，并选择出感兴趣的字段</li><li><code>WHERE</code> 子句用于对 SELECT 选择出来的某个字段施加条件过滤</li></ul><p><strong>FOREACH、DO 和 INCASE 子句:</strong></p><p>如果对于一个数组数据，想针对数组中的每个元素分别执行一些操作并执行 Actions，需要使用 <code>FOREACH-DO-INCASE</code> 语法。其基本格式为:</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">字段名</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">条件</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INCASE </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">条件</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">主题</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">条件</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>FOREACH</code> 子句用于选择需要做 foreach 操作的字段，注意选择出的字段必须为数组类型</li><li><code>DO</code> 子句用于对 FOREACH 选择出来的数组中的每个元素进行变换，并选择出感兴趣的字段</li><li><code>INCASE</code> 子句用于对 DO 选择出来的某个字段施加条件过滤</li></ul><p>其中 DO 和 INCASE 子句都是可选的。DO 相当于针对当前循环中对象的 SELECT 子句，而 INCASE 相当于针对当前循环中对象的 WHERE 语句。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="事件和事件主题">事件和事件主题<a class="hash-link" href="#事件和事件主题" title="Direct link to heading">​</a></h4><p>规则引擎的 SQL 语句既可以处理消息(消息发布)，也可以处理事件(客户端上下线、客户端订阅等)。对于消息，FROM 子句后面直接跟主题名；对于事件，FROM 子句后面跟事件主题。</p><p>事件消息的主题以 <code>&quot;$events/&quot;</code> 开头，比如 <code>&quot;$events/client_connected&quot;,</code> <code>&quot;$events/session_subscribed&quot;。</code>
如果想让 emqx 将事件消息发布出来，可以在 <code>emqx_rule_engine.conf</code> 文件中配置。</p><p>所有支持的事件及其可用字段详见: <a href="#rule-sql-events">规则事件</a>。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="sql-语句示例">SQL 语句示例:<a class="hash-link" href="#sql-语句示例" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_nANs" id="基本语法举例">基本语法举例<a class="hash-link" href="#基本语法举例" title="Direct link to heading">​</a></h5><ul><li>从 topic 为 &quot;t/a&quot; 的消息中提取所有字段:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/a&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从 topic 为 &quot;t/a&quot; 或 &quot;t/b&quot; 的消息中提取所有字段:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;t/b&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从 topic 能够匹配到 &#x27;t/#&#x27; 的消息中提取所有字段。</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从 topic 能够匹配到 &#x27;t/#&#x27; 的消息中提取 qos, username 和 clientid 字段:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> qos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clientid </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从任意 topic 的消息中提取 username 字段，并且筛选条件为 username = &#x27;Steven&#x27;:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> username </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> username</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Steven&#x27;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>从任意 topic 的 JSON 消息体(payload) 中提取 x 字段，并创建别名 x 以便在 WHERE 子句中使用。WHERE 子句限定条件为 x = 1。下面这个 SQL 语句可以匹配到消息体 {&quot;x&quot;: 1}, 但不能匹配到消息体 {&quot;x&quot;: 2}:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> payload </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> p </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>类似于上面的 SQL 语句，但嵌套地提取消息体中的数据，下面的 SQL 语句可以匹配到 JSON 消息体 {&quot;x&quot;: {&quot;y&quot;: 1}}:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> payload </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;#&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在 clientid = &#x27;c1&#x27; 尝试连接时，提取其来源 IP 地址和端口号:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> peername </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> ip_port </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/client_connected&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> clientid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;c1&#x27;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>筛选所有订阅 &#x27;t/#&#x27; 主题且订阅级别为 QoS1 的 clientid:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> clientid </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/session_subscribed&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> topic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;t/#&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> qos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>筛选所有订阅主题能匹配到 &#x27;t/#&#x27; 且订阅级别为 QoS1 的 clientid。注意与上例不同的是，这里用的是主题匹配操作符 <strong>&#x27;=~&#x27;</strong>，所以会匹配订阅 &#x27;t&#x27; 或 &#x27;t/+/a&#x27; 的订阅事件:</li></ul><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> clientid </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$events/session_subscribed&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> topic </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;t/#&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> qos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>::: tip</p><ul><li>FROM 子句后面的主题需要用双引号 <code>&quot;&quot;</code> 引起来。</li><li>WHERE 子句后面接筛选条件，如果使用到字符串需要用单引号 <code>&#x27;&#x27;</code> 引起来。</li><li>FROM 子句里如有多个主题，需要用逗号 <code>&quot;,&quot;</code> 分隔。例如 SELECT * FROM &quot;t/1&quot;, &quot;t/2&quot; 。</li><li>可以使用使用 <code>&quot;.&quot;</code> 符号对 payload 进行嵌套选择。</li></ul><p>:::</p><h5 class="anchor anchorWithStickyNavbar_nANs" id="遍历语法foreach-do-incase-举例">遍历语法(FOREACH-DO-INCASE) 举例<a class="hash-link" href="#遍历语法foreach-do-incase-举例" title="Direct link to heading">​</a></h5><p>假设有 ClientID 为 <code>c_steve</code>、主题为 <code>t/1</code> 的消息，消息体为 JSON 格式，其中 sensors 字段为包含多个 Object 的数组:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;date&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-04-24&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;sensors&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;b&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例1: 要求将 sensors 里的各个对象，分别作为数据输入重新发布消息到 <code>sensors/${idx}</code> 主题，内容为 <code>${name}</code>。即最终规则引擎将会发出 3 条消息:</strong></p><p>1) 主题：sensors/0
内容：a
2) 主题：sensors/1
内容：b
3) 主题：sensors/2
内容：c</p><p>要完成这个规则，我们需要配置如下动作：</p><ul><li>动作类型：消息重新发布 (republish)</li><li>目的主题：sensors/${idx}</li><li>目的 QoS：0</li><li>消息内容模板：${name}</li></ul><p>以及如下 SQL 语句：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例解析:</strong></p><p>这个 SQL 中，FOREACH 子句指定需要进行遍历的数组 sensors，则选取结果为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;b&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FOREACH 语句将会对于结果数组里的每个对象分别执行 &quot;消息重新发布&quot; 动作，所以将会执行重新发布动作 3 次。</p><p><strong>示例2: 要求将 sensors 里的 <code>idx</code> 值大于或等于 1 的对象，分别作为数据输入重新发布消息到 <code>sensors/${idx}</code> 主题，内容为 <code>clientid=${clientid},name=${name},date=${date}</code>。即最终规则引擎将会发出 2 条消息:</strong></p><p>1) 主题：sensors/1
内容：clientid=c_steve,name=b,date=2020-04-24
2) 主题：sensors/2
内容：clientid=c_steve,name=c,date=2020-04-24</p><p>要完成这个规则，我们需要配置如下动作：</p><ul><li>动作类型：消息重新发布 (republish)</li><li>目的主题：sensors/${idx}</li><li>目的 QoS：0</li><li>消息内容模板：clientid=${clientid},name=${name},date=${date}</li></ul><p>以及如下 SQL 语句：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> idx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INCASE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例解析:</strong></p><p>这个 SQL 中，FOREACH 子句指定需要进行遍历的数组 <code>sensors</code>; DO 子句选取每次操作需要的字段，这里我们选了外层的 <code>clientid</code> 字段，以及当前 sensor 对象的 <code>name</code> 和 <code>idx</code> 两个字段，注意 <code>item</code> 代表 sensors 数组中本次循环的对象。INCASE 子句是针对 DO 语句中字段的筛选条件，仅仅当 idx &gt;= 1 满足条件。所以 SQL 的选取结果为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;b&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;clientid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c_emqx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;clientid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c_emqx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FOREACH 语句将会对于结果数组里的每个对象分别执行 &quot;消息重新发布&quot; 动作，所以将会执行重新发布动作 2 次。</p><p>在 DO 和 INCASE 语句里，可以使用 <code>item</code> 访问当前循环的对象，也可以通过在 FOREACH 使用 <code>as</code> 语法自定义一个变量名。所以本例中的 SQL 语句又可以写为：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> idx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INCASE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例3: 在示例2 的基础上，去掉 clientid 字段 <code>c_steve</code> 中的 <code>c_</code> 前缀</strong></p><p>在 FOREACH 和 DO 语句中可以调用各类 SQL 函数，若要将 <code>c_steve</code> 变为 <code>steve</code>，则可以把例2 中的 SQL 改为：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tokens</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clientid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;_&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> clientid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> idx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INCASE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idx </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>另外，FOREACH 子句中也可以放多个表达式，只要最后一个表达式是指定要遍历的数组即可。比如我们将消息体改一下，sensors 外面多套一层 Object：</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;date&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2020-04-24&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;sensors&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;b&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;idx&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>则 FOREACH 中可以在决定要遍历的数组之前把 data 选取出来：</p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">FOREACH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sensors </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_nANs" id="case-when-语法示例">CASE-WHEN 语法示例<a class="hash-link" href="#case-when-语法示例" title="Direct link to heading">​</a></h5><p><strong>示例1: 将消息中 x 字段的值范围限定在 0~7 之间。</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">CASE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">ELSE</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设消息为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;x&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>则上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;x&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_nANs" id="数组操作语法举例">数组操作语法举例<a class="hash-link" href="#数组操作语法举例" title="Direct link to heading">​</a></h5><p><strong>示例1: 创建一个数组，赋值给变量 a:</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下标从 1 开始，上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;a&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例2: 从数组中取出第 N 个元素。下标为负数时，表示从数组的右边取:</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;b&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;c&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;a&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例3: 从 JSON 格式的 payload 中嵌套的获取值:</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设消息为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;steve&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bill&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>则上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例4: 数组范围(range)操作:</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1.</span><span class="token number" style="color:#36acaa">.5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  a</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2.</span><span class="token number" style="color:#36acaa">.4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;b&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;a&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>示例5: 使用下标语法修改数组中的某个元素:</strong></p><div class="language-sql codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-sql codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;STEVE&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>假设消息为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;steve&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bill&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>则上面的 SQL 输出为:</p><div class="language-json codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-json codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;payload&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;STEVE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bill&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_nANs" id="from-子句可用的事件主题">FROM 子句可用的事件主题<a class="hash-link" href="#from-子句可用的事件主题" title="Direct link to heading">​</a></h4><table><thead><tr><th>事件主题名</th><th align="left">释义</th></tr></thead><tbody><tr><td>$events/message_delivered</td><td align="left">消息投递</td></tr><tr><td>$events/message_acked</td><td align="left">消息确认</td></tr><tr><td>$events/message_dropped</td><td align="left">消息丢弃</td></tr><tr><td>$events/client_connected</td><td align="left">连接完成</td></tr><tr><td>$events/client_disconnected</td><td align="left">连接断开</td></tr><tr><td>$events/session_subscribed</td><td align="left">订阅</td></tr><tr><td>$events/session_unsubscribed</td><td align="left">取消订阅</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="select-和-where-子句可用的字段">SELECT 和 WHERE 子句可用的字段<a class="hash-link" href="#select-和-where-子句可用的字段" title="Direct link to heading">​</a></h4><p>SELECT 和 WHERE 子句可用的字段与事件的类型相关。其中 <code>clientid</code>, <code>username</code> 和 <code>event</code> 是通用字段，每种事件类型都有。</p><h5 class="anchor anchorWithStickyNavbar_nANs" id="普通主题-消息发布">普通主题 (消息发布)<a class="hash-link" href="#普通主题-消息发布" title="Direct link to heading">​</a></h5><table><thead><tr><th align="left">event</th><th align="left">事件类型，固定为 &quot;message.publish&quot;</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">MQTT 消息 ID</td></tr><tr><td align="left">clientid</td><td align="left">Client ID</td></tr><tr><td align="left">username</td><td align="left">用户名</td></tr><tr><td align="left">payload</td><td align="left">MQTT 消息体</td></tr><tr><td align="left">peerhost</td><td align="left">客户端的 IPAddress</td></tr><tr><td align="left">topic</td><td align="left">MQTT 主题</td></tr><tr><td align="left">qos</td><td align="left">MQTT 消息的 QoS</td></tr><tr><td align="left">flags</td><td align="left">MQTT 消息的 Flags</td></tr><tr><td align="left">headers</td><td align="left">MQTT 消息内部与流程处理相关的额外数据</td></tr><tr><td align="left">timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td align="left">publish_received_at</td><td align="left">PUBLISH 消息到达 Broker 的时间 (ms)</td></tr><tr><td align="left">node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventsmessage_delivered-消息投递">$events/message_delivered (消息投递)<a class="hash-link" href="#eventsmessage_delivered-消息投递" title="Direct link to heading">​</a></h5><table><thead><tr><th>event</th><th>事件类型，固定为 &quot;message.delivered&quot;</th></tr></thead><tbody><tr><td>id</td><td>MQTT 消息 ID</td></tr><tr><td>from_clientid</td><td>消息来源 Client ID</td></tr><tr><td>from_username</td><td>消息来源用户名</td></tr><tr><td>clientid</td><td>消息目的 Client ID</td></tr><tr><td>username</td><td>消息目的用户名</td></tr><tr><td>payload</td><td>MQTT 消息体</td></tr><tr><td>peerhost</td><td>客户端的 IPAddress</td></tr><tr><td>topic</td><td>MQTT 主题</td></tr><tr><td>qos</td><td>MQTT 消息的 QoS</td></tr><tr><td>flags</td><td>MQTT 消息的 Flags</td></tr><tr><td>timestamp</td><td>事件触发时间 (ms)</td></tr><tr><td>publish_received_at</td><td>PUBLISH 消息到达 Broker 的时间 (ms)</td></tr><tr><td>node</td><td>事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventsmessage_acked-消息确认">$events/message_acked (消息确认)<a class="hash-link" href="#eventsmessage_acked-消息确认" title="Direct link to heading">​</a></h5><table><thead><tr><th align="left">event</th><th align="left">事件类型，固定为 &quot;message.acked&quot;</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">MQTT 消息 ID</td></tr><tr><td align="left">from_clientid</td><td align="left">消息来源 Client ID</td></tr><tr><td align="left">from_username</td><td align="left">消息来源用户名</td></tr><tr><td align="left">clientid</td><td align="left">消息目的 Client ID</td></tr><tr><td align="left">username</td><td align="left">消息目的用户名</td></tr><tr><td align="left">payload</td><td align="left">MQTT 消息体</td></tr><tr><td align="left">peerhost</td><td align="left">客户端的 IPAddress</td></tr><tr><td align="left">topic</td><td align="left">MQTT 主题</td></tr><tr><td align="left">qos</td><td align="left">MQTT 消息的 QoS</td></tr><tr><td align="left">flags</td><td align="left">MQTT 消息的 Flags</td></tr><tr><td align="left">timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td align="left">publish_received_at</td><td align="left">PUBLISH 消息到达 Broker 的时间 (ms)</td></tr><tr><td align="left">node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventsmessage_dropped-消息丢弃">$events/message_dropped (消息丢弃)<a class="hash-link" href="#eventsmessage_dropped-消息丢弃" title="Direct link to heading">​</a></h5><table><thead><tr><th align="left">event</th><th align="left">事件类型，固定为 &quot;message.dropped&quot;</th></tr></thead><tbody><tr><td align="left">id</td><td align="left">MQTT 消息 ID</td></tr><tr><td align="left">reason</td><td align="left">消息丢弃原因</td></tr><tr><td align="left">clientid</td><td align="left">消息目的 Client ID</td></tr><tr><td align="left">username</td><td align="left">消息目的用户名</td></tr><tr><td align="left">payload</td><td align="left">MQTT 消息体</td></tr><tr><td align="left">peerhost</td><td align="left">客户端的 IPAddress</td></tr><tr><td align="left">topic</td><td align="left">MQTT 主题</td></tr><tr><td align="left">qos</td><td align="left">MQTT 消息的 QoS</td></tr><tr><td align="left">flags</td><td align="left">MQTT 消息的 Flags</td></tr><tr><td align="left">timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td align="left">publish_received_at</td><td align="left">PUBLISH 消息到达 Broker 的时间 (ms)</td></tr><tr><td align="left">node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventsclient_connected-终端连接成功">$events/client_connected (终端连接成功)<a class="hash-link" href="#eventsclient_connected-终端连接成功" title="Direct link to heading">​</a></h5><table><thead><tr><th>event</th><th align="left">事件类型，固定为 &quot;client.connected&quot;</th></tr></thead><tbody><tr><td>clientid</td><td align="left">消息目的 Client ID</td></tr><tr><td>username</td><td align="left">消息目的用户名</td></tr><tr><td>mountpoint</td><td align="left">主题挂载点(主题前缀)</td></tr><tr><td>peername</td><td align="left">终端的 IPAddress 和 Port</td></tr><tr><td>sockname</td><td align="left">emqx 监听的 IPAddress 和 Port</td></tr><tr><td>proto_name</td><td align="left">协议名字</td></tr><tr><td>proto_ver</td><td align="left">协议版本</td></tr><tr><td>keepalive</td><td align="left">MQTT 保活间隔</td></tr><tr><td>clean_start</td><td align="left">MQTT clean_start</td></tr><tr><td>expiry_interval</td><td align="left">MQTT Session 过期时间</td></tr><tr><td>is_bridge</td><td align="left">是否为 MQTT bridge 连接</td></tr><tr><td>connected_at</td><td align="left">终端连接完成时间 (s)</td></tr><tr><td>timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td>node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventsclient_disconnected-终端连接断开">$events/client_disconnected (终端连接断开)<a class="hash-link" href="#eventsclient_disconnected-终端连接断开" title="Direct link to heading">​</a></h5><table><thead><tr><th>event</th><th align="left">事件类型，固定为 &quot;client.disconnected&quot;</th></tr></thead><tbody><tr><td>reason</td><td align="left">终端连接断开原因：<br>normal：客户端主动断开<br>kicked：服务端踢出，通过 REST API<br>keepalive_timeout: keepalive 超时<br>not_authorized:  认证失败，或者 acl_nomatch = disconnect 时没有权限的 Pub/Sub 会主动断开客户端<br>tcp_closed: 协议错误<br>internal_error: 畸形报文解析出错<br></td></tr><tr><td>clientid</td><td align="left">消息目的 Client ID</td></tr><tr><td>username</td><td align="left">消息目的用户名</td></tr><tr><td>peername</td><td align="left">终端的 IPAddress 和 Port</td></tr><tr><td>sockname</td><td align="left">emqx 监听的 IPAddress 和 Port</td></tr><tr><td>disconnected_at</td><td align="left">终端连接断开时间 (s)</td></tr><tr><td>timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td>node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventssession_subscribed-终端订阅成功">$events/session_subscribed (终端订阅成功)<a class="hash-link" href="#eventssession_subscribed-终端订阅成功" title="Direct link to heading">​</a></h5><table><thead><tr><th>event</th><th>事件类型，固定为 &quot;session.subscribed&quot;</th></tr></thead><tbody><tr><td>clientid</td><td>消息目的 Client ID</td></tr><tr><td>username</td><td>消息目的用户名</td></tr><tr><td>peerhost</td><td>客户端的 IPAddress</td></tr><tr><td>topic</td><td>MQTT 主题</td></tr><tr><td>qos</td><td>MQTT 消息的 QoS</td></tr><tr><td>timestamp</td><td>事件触发时间 (ms)</td></tr><tr><td>node</td><td>事件触发所在节点</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="eventssession_unsubscribed-取消终端订阅成功">$events/session_unsubscribed (取消终端订阅成功)<a class="hash-link" href="#eventssession_unsubscribed-取消终端订阅成功" title="Direct link to heading">​</a></h5><table><thead><tr><th align="left">event</th><th align="left">事件类型，固定为 &quot;session.unsubscribed&quot;</th></tr></thead><tbody><tr><td align="left">clientid</td><td align="left">消息目的 Client ID</td></tr><tr><td align="left">username</td><td align="left">消息目的用户名</td></tr><tr><td align="left">peerhost</td><td align="left">客户端的 IPAddress</td></tr><tr><td align="left">topic</td><td align="left">MQTT 主题</td></tr><tr><td align="left">qos</td><td align="left">MQTT 消息的 QoS</td></tr><tr><td align="left">timestamp</td><td align="left">事件触发时间 (ms)</td></tr><tr><td align="left">node</td><td align="left">事件触发所在节点</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="sql-关键字和符号">SQL 关键字和符号<a class="hash-link" href="#sql-关键字和符号" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_nANs" id="select---from---where-语句">SELECT - FROM - WHERE 语句<a class="hash-link" href="#select---from---where-语句" title="Direct link to heading">​</a></h5><p>SELECT 语句用于决定最终的输出结果里的字段。比如:</p><p>下面 SQL 的输出结果中将只有两个字段 &quot;a&quot; 和 &quot;b&quot;:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT a, b FROM &quot;t/#&quot;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>WHERE 语句用于对本事件中可用字段，或 SELECT 语句中定义的字段进行条件过滤。比如:</p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain"># 选取 username 为 &#x27;abc&#x27; 的终端发来的消息，输出结果为所有可用字段:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM &quot;#&quot; WHERE username = &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 选取 clientid 为 &#x27;abc&#x27; 的终端发来的消息，输出结果将只有 cid 一个字段。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 注意 cid 变量是在 SELECT 语句中定义的，故可在 WHERE 语句中使用:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT clientid as cid FROM &quot;#&quot; WHERE cid = &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 选取 username 为 &#x27;abc&#x27; 的终端发来的消息，输出结果将只有 cid 一个字段。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 注意虽然 SELECT 语句中只选取了 cid 一个字段，所有消息发布事件中的可用字段 (比如 clientid, username 等) 仍然可以在 WHERE 语句中使用:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT clientid as cid FROM &quot;#&quot; WHERE username = &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 但下面这个 SQL 语句就不能工作了，因为变量 xyz 既不是消息发布事件中的可用字段，又没有在 SELECT 语句中定义:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT clientid as cid FROM &quot;#&quot; WHERE xyz = &#x27;abc&#x27;</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>FROM 语句用于选择事件来源。如果是消息发布则填写消息的主题，如果是事件则填写对应的事件主题。</p><h5 class="anchor anchorWithStickyNavbar_nANs" id="运算符号">运算符号<a class="hash-link" href="#运算符号" title="Direct link to heading">​</a></h5><table><thead><tr><th>函数名</th><th>函数作用</th><th>返回值</th><th></th></tr></thead><tbody><tr><td><code>+</code></td><td>加法，或字符串拼接</td><td>加和，或拼接之后的字符串</td><td></td></tr><tr><td><code>-</code></td><td>减法</td><td>差值</td><td></td></tr><tr><td><code>*</code></td><td>乘法</td><td>乘积</td><td></td></tr><tr><td><code>/</code></td><td>除法</td><td>商值</td><td></td></tr><tr><td><code>div</code></td><td>整数除法</td><td>整数商值</td><td></td></tr><tr><td><code>mod</code></td><td>取模</td><td>模</td><td></td></tr><tr><td><code>=</code></td><td>比较两者是否完全相等。可用于比较变量和主题</td><td>true/false</td><td></td></tr><tr><td><code>=~</code></td><td>比较主题(topic)是否能够匹配到主题过滤器(topic filter)。只能用于主题匹配</td><td>true/false</td><td></td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="sql-语句中可用的函数">SQL 语句中可用的函数<a class="hash-link" href="#sql-语句中可用的函数" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_nANs" id="数学函数">数学函数<a class="hash-link" href="#数学函数" title="Direct link to heading">​</a></h5><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>abs</td><td>绝对值</td><td><ol type="1"><li>被操作数</li></ol></td><td>绝对值</td></tr><tr class="odd"><td>cos</td><td>余弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>余弦值</td></tr><tr class="even"><td>cosh</td><td>双曲余弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>双曲余弦值</td></tr><tr class="odd"><td>acos</td><td>反余弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>反余弦值</td></tr><tr class="even"><td>acosh</td><td>反双曲余弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>反双曲余弦值</td></tr><tr class="odd"><td>sin</td><td>正弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>正弦值</td></tr><tr class="even"><td>sinh</td><td>双曲正弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>双曲正弦值</td></tr><tr class="odd"><td>asin</td><td>反正弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>值</td></tr><tr class="even"><td>asinh</td><td>反双曲正弦</td><td><ol type="1"><li>被操作数</li></ol></td><td>反双曲正弦值</td></tr><tr class="odd"><td>tan</td><td>正切</td><td><ol type="1"><li>被操作数</li></ol></td><td>正切值</td></tr><tr class="even"><td>tanh</td><td>双曲正切</td><td><ol type="1"><li>被操作数</li></ol></td><td>双曲正切值</td></tr><tr class="odd"><td>atan</td><td>反正切</td><td><ol type="1"><li>被操作数</li></ol></td><td>反正切值</td></tr><tr class="even"><td>atanh</td><td>反双曲正切</td><td><ol type="1"><li>被操作数</li></ol></td><td>反双曲正切值</td></tr><tr class="odd"><td>ceil</td><td>上取整</td><td><ol type="1"><li>被操作数</li></ol></td><td>整数值</td></tr><tr class="even"><td>floor</td><td>下取整</td><td><ol type="1"><li>被操作数</li></ol></td><td>整数值</td></tr><tr class="odd"><td>round</td><td>四舍五入</td><td><ol type="1"><li>被操作数</li></ol></td><td>整数值</td></tr><tr class="even"><td>exp</td><td>幂运算</td><td><ol type="1"><li>被操作数</li></ol></td><td>e 的 x 次幂</td></tr><tr class="odd"><td>power</td><td>指数运算</td><td><ol type="1"><li>左操作数 x 2. 右操作数 y</li></ol></td><td>x 的 y 次方</td></tr><tr class="even"><td>sqrt</td><td>平方根运算</td><td><ol type="1"><li>被操作数</li></ol></td><td>平方根</td></tr><tr class="odd"><td>fmod</td><td>负点数取模函数</td><td><ol type="1"><li>左操作数 2. 右操作数</li></ol></td><td>模</td></tr><tr class="even"><td>log</td><td>以 e 为底对数</td><td><ol type="1"><li>被操作数</li></ol></td><td>值</td></tr><tr class="odd"><td>log10</td><td>以 10 为底对数</td><td><ol type="1"><li>被操作数</li></ol></td><td>值</td></tr><tr class="even"><td>log2</td><td>以 2 为底对数</td><td><ol type="1"><li>被操作数</li></ol></td><td>值</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="数据类型判断函数">数据类型判断函数<a class="hash-link" href="#数据类型判断函数" title="Direct link to heading">​</a></h5><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>is_null</td><td>判断变量是否为空值</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。如果为空值(undefined) 则返回 true，否则返回 false</td></tr><tr class="odd"><td>is_not_null</td><td>判断变量是否为非空值</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。如果为空值(undefined) 则返回 false，否则返回 true</td></tr><tr class="even"><td>is_str</td><td>判断变量是否为 String 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="odd"><td>is_bool</td><td>判断变量是否为 Boolean 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="even"><td>is_int</td><td>判断变量是否为 Integer 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="odd"><td>is_float</td><td>判断变量是否为 Float 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="even"><td>is_num</td><td>判断变量是否为数字类型，包括 Integer 和 Float 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="odd"><td>is_map</td><td>判断变量是否为 Map 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr><tr class="even"><td>is_array</td><td>判断变量是否为 Array 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="数据类型转换函数">数据类型转换函数<a class="hash-link" href="#数据类型转换函数" title="Direct link to heading">​</a></h5><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>str</td><td>将数据转换为 String 类型</td><td><ol type="1"><li>Data</li></ol></td><td>String 类型的数据。无法转换将会导致 SQL 匹配失败</td></tr><tr class="odd"><td>str_utf8</td><td>将数据转换为 UTF-8 String 类型</td><td><ol type="1"><li>Data</li></ol></td><td>UTF-8 String 类型的数据。无法转换将会导致 SQL 匹配失败</td></tr><tr class="even"><td>bool</td><td>将数据转换为 Boolean 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Boolean 类型的数据。无法转换将会导致 SQL 匹配失败</td></tr><tr class="odd"><td>int</td><td>将数据转换为整数类型</td><td><ol type="1"><li>Data</li></ol></td><td>整数类型的数据。无法转换将会导致 SQL 匹配失败</td></tr><tr class="even"><td>float</td><td>将数据转换为浮点型类型</td><td><ol type="1"><li>Data</li></ol></td><td>浮点型类型的数据。无法转换将会导致 SQL 匹配失败</td></tr><tr class="odd"><td>map</td><td>将数据转换为 Map 类型</td><td><ol type="1"><li>Data</li></ol></td><td>Map 类型的数据。无法转换将会导致 SQL 匹配失败</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="字符串函数">字符串函数<a class="hash-link" href="#字符串函数" title="Direct link to heading">​</a></h5><table><thead><tr><th>函数名</th><th>函数作用</th><th>参数</th><th>返回值</th><th>举例</th></tr></thead><tbody><tr><td>lower</td><td>转为小写</td><td>1. 原字符串</td><td>小写字符串</td><td><code> 1. lower(&#x27;AbC&#x27;) = &#x27;abc&#x27;</code><br><br><code>2. lower(&#x27;abc&#x27;) = &#x27;abc&#x27; </code></td></tr><tr><td>upper</td><td>转为大写</td><td>1. 原字符串</td><td>大写字符串</td><td><code> 1. upper(&#x27;AbC&#x27;) = &#x27;ABC&#x27;</code><br><br><code>2. lower(&#x27;ABC&#x27;) = &#x27;ABC&#x27; </code></td></tr><tr><td>trim</td><td>去掉左右空格</td><td>1. 原字符串</td><td>去掉空格后的字符串</td><td><code>1. trim(&#x27; hello  &#x27;) = &#x27;hello&#x27;</code></td></tr><tr><td>ltrim</td><td>去掉左空格</td><td>1. 原字符串</td><td>去掉空格后的字符串</td><td><code> 1. ltrim(&#x27; hello  &#x27;) = &#x27;hello  &#x27;</code></td></tr><tr><td>rtrim</td><td>去掉右空格</td><td>1. 原字符串</td><td>去掉空格后的字符串</td><td><code> 1. rtrim(&#x27; hello  &#x27;) = &#x27; hello&#x27;</code></td></tr><tr><td>reverse</td><td>字符串反转</td><td>1. 原字符串</td><td>翻转后的字符串</td><td><code>1. reverse(&#x27;hello&#x27;) = &#x27;olleh&#x27;</code></td></tr><tr><td>strlen</td><td>取字符串长度</td><td>1. 原字符串</td><td>整数值，字符长度</td><td><code>1. strlen(&#x27;hello&#x27;) = 5</code></td></tr><tr><td>substr</td><td>取字符的子串</td><td>1. 原字符串 2. 起始位置. 注意: 下标从 0 开始</td><td>子串</td><td><code>1. substr(&#x27;abcdef&#x27;, 2) = &#x27;cdef&#x27;</code></td></tr><tr><td>substr</td><td>取字符的子串</td><td>1. 原字符串 2. 起始位置 3. 要取出的子串长度. 注意: 下标从 0 开始</td><td>子串</td><td><code>1. substr(&#x27;abcdef&#x27;, 2, 3) = &#x27;cde&#x27;</code></td></tr><tr><td>split</td><td>字符串分割</td><td>1. 原字符串 2. 分割符子串</td><td>分割后的字符串数组</td><td><code>1. split(&#x27;a/b/ c&#x27;, &#x27;/&#x27;) = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27; c&#x27;]</code></td></tr><tr><td>split</td><td>字符串分割, 只查找左边第一个分隔符</td><td>1. 原字符串 2. 分割符子串 3. &#x27;leading&#x27;</td><td>分割后的字符串数组</td><td><code>1. split(&#x27;a/b/ c&#x27;, &#x27;/&#x27;, &#x27;leading&#x27;) = [&#x27;a&#x27;, &#x27;b/ c&#x27;]</code></td></tr><tr><td>split</td><td>字符串分割, 只查找右边第一个分隔符</td><td>1. 原字符串 2. 分割符子串 3. &#x27;trailing&#x27;</td><td>分割后的字符串数组</td><td><code>1. split(&#x27;a/b/ c&#x27;, &#x27;/&#x27;, &#x27;trailing&#x27;) = [&#x27;a/b&#x27;, &#x27; c&#x27;]</code></td></tr><tr><td>concat</td><td>字符串拼接</td><td>1. 左字符串 2. 右符子串</td><td>拼接后的字符串</td><td><code>1. concat(&#x27;a&#x27;, &#x27;/bc&#x27;) = &#x27;a/bc&#x27;</code><br><br><code>2. &#x27;a&#x27; + &#x27;/bc&#x27; = &#x27;a/bc&#x27;</code></td></tr><tr><td>tokens</td><td>字符串分解(按照指定字符串符分解)</td><td>1. 输入字符串 2. 分割符或字符串</td><td>分解后的字符串数组</td><td><code>1. tokens(&#x27; a/b/ c&#x27;, &#x27;/&#x27;) = [&#x27; a&#x27;, &#x27;b&#x27;, &#x27; c&#x27;]</code><br><br><code>2. tokens(&#x27; a/b/ c&#x27;, &#x27;/ &#x27;) = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</code><br><br><code>3. tokens(&#x27; a/b/ c\n&#x27;, &#x27;/ &#x27;) = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c\n&#x27;]</code></td></tr><tr><td>tokens</td><td>字符串分解(按照指定字符串和换行符分解)</td><td>1. 输入字符串 2. 分割符或字符串 3. &#x27;nocrlf&#x27;</td><td>分解后的字符串数组</td><td><code>1. tokens(&#x27; a/b/ c\n&#x27;, &#x27;/ &#x27;, &#x27;nocrlf&#x27;) = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</code><br><br><code>2. tokens(&#x27; a/b/ c\r\n&#x27;, &#x27;/ &#x27;, &#x27;nocrlf&#x27;) = [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</code></td></tr><tr><td>sprintf</td><td>字符串格式化, 格式字符串的用法详见 <a href="https://erlang.org/doc/man/io.html#fwrite-1" target="_blank" rel="noopener noreferrer">https://erlang.org/doc/man/io.html#fwrite-1</a> 里的 Format 部分</td><td>1. 格式字符串 2,3,4... 参数列表。参数个数不定</td><td>分解后的字符串数组</td><td><code>1. sprintf(&#x27;hello, ~s!&#x27;, &#x27;steve&#x27;) = &#x27;hello, steve!&#x27;</code><br><br><code>2. sprintf(&#x27;count: ~p~n&#x27;, 100) = &#x27;count: 100\n&#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补空格，从尾部补足</td><td>1. 原字符串 2. 字符总长度</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5) = &#x27;abc  &#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补空格，从尾部补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;trailing&#x27;</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;trailing&#x27;) = &#x27;abc  &#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补空格，从两边补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;both&#x27;</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;both&#x27;) = &#x27; abc &#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补空格，从头部补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;leading&#x27;</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;leading&#x27;) = &#x27;  abc&#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补指定字符，从尾部补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;trailing&#x27; 4. 指定用于补足的字符</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;trailing&#x27;, &#x27;*&#x27;) = &#x27;abc**&#x27;</code><br><br><code>2. pad(&#x27;abc&#x27;, 5, &#x27;trailing&#x27;, &#x27;*#&#x27;) = &#x27;abc*#*#&#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补指定字符，从两边补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;both&#x27; 4. 指定用于补足的字符</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;both&#x27;, &#x27;*&#x27;) = &#x27;*abc*&#x27;</code><br><br><code>2. pad(&#x27;abc&#x27;, 5, &#x27;both&#x27;, &#x27;*#&#x27;) = &#x27;*#abc*#&#x27;</code></td></tr><tr><td>pad</td><td>字符串补足长度，补指定字符，从头部补足</td><td>1. 原字符串 2. 字符总长度 3. &#x27;leading&#x27; 4. 指定用于补足的字符</td><td>补足后的字符串</td><td><code>1. pad(&#x27;abc&#x27;, 5, &#x27;leading&#x27;, &#x27;*&#x27;) = &#x27;**abc&#x27;</code><br><br><code>2. pad(&#x27;abc&#x27;, 5, &#x27;leading&#x27;, &#x27;*#&#x27;) = &#x27;*#*#abc&#x27;</code></td></tr><tr><td>replace</td><td>替换字符串中的某子串，查找所有匹配子串替换</td><td>1. 原字符串 2. 要被替换的子串 3. 指定用于替换的字符串</td><td>替换后的字符串</td><td><code>1. replace(&#x27;ababef&#x27;, &#x27;ab&#x27;, &#x27;cd&#x27;) = &#x27;cdcdef&#x27;</code></td></tr><tr><td>replace</td><td>替换字符串中的某子串，查找所有匹配子串替换</td><td>1. 原字符串 2. 要被替换的子串 3. 指定用于替换的字符串 4. &#x27;all&#x27;</td><td>替换后的字符串</td><td><code>1. replace(&#x27;ababef&#x27;, &#x27;ab&#x27;, &#x27;cd&#x27;, &#x27;all&#x27;) = &#x27;cdcdef&#x27;</code></td></tr><tr><td>replace</td><td>替换字符串中的某子串，从尾部查找第一个匹配子串替换</td><td>1. 原字符串 2. 要被替换的子串 3. 指定用于替换的字符串 4. &#x27;trailing&#x27;</td><td>替换后的字符串</td><td><code>1. replace(&#x27;ababef&#x27;, &#x27;ab&#x27;, &#x27;cd&#x27;, &#x27;trailing&#x27;) = &#x27;abcdef&#x27;</code></td></tr><tr><td>replace</td><td>替换字符串中的某子串，从头部查找第一个匹配子串替换</td><td>1. 原字符串 2. 要被替换的子串 3. 指定用于替换的字符串 4. &#x27;leading&#x27;</td><td>替换后的字符串</td><td><code>1. replace(&#x27;ababef&#x27;, &#x27;ab&#x27;, &#x27;cd&#x27;, &#x27;leading&#x27;) = &#x27;cdabef&#x27;</code></td></tr><tr><td>regex_match</td><td>判断字符串是否与某正则表达式匹配</td><td>1. 原字符串 2. 正则表达式</td><td>true 或 false</td><td><code>1. regex_match(&#x27;abc123&#x27;, &#x27;[a-zA-Z1-9]*&#x27;) = true</code></td></tr><tr><td>regex_replace</td><td>替换字符串中匹配到某正则表达式的子串</td><td>1. 原字符串 2. 正则表达式 3. 指定用于替换的字符串</td><td>替换后的字符串</td><td><code>1. regex_replace(&#x27;ab1cd3ef&#x27;, &#x27;[1-9]&#x27;, &#x27;[&amp;]&#x27;) = &#x27;ab[1]cd[3]ef&#x27;</code><br><br><code>2. regex_replace(&#x27;ccefacef&#x27;, &#x27;c+&#x27;, &#x27;:&#x27;) = &#x27;:efa:ef&#x27;</code></td></tr><tr><td>ascii</td><td>返回字符对应的 ASCII 码</td><td>1. 字符</td><td>整数值，字符对应的 ASCII 码</td><td><code>1. ascii(&#x27;a&#x27;) = 97</code></td></tr><tr><td>find</td><td>查找并返回字符串中的某个子串，从头部查找</td><td>1. 原字符串 2. 要查找的子串</td><td>查抄到的子串，如找不到则返回空字符串</td><td><code>1. find(&#x27;eeabcabcee&#x27;, &#x27;abc&#x27;) = &#x27;abcabcee&#x27;</code></td></tr><tr><td>find</td><td>查找并返回字符串中的某个子串，从头部查找</td><td>1. 原字符串 2. 要查找的子串 3. &#x27;leading&#x27;</td><td>查抄到的子串，如找不到则返回空字符串</td><td><code>1. find(&#x27;eeabcabcee&#x27;, &#x27;abc&#x27;, &#x27;leading&#x27;) = &#x27;abcabcee&#x27;</code></td></tr><tr><td>find</td><td>查找并返回字符串中的某个子串，从尾部查找</td><td>1. 原字符串 2. 要查找的子串 3. &#x27;trailing&#x27;</td><td>查抄到的子串，如找不到则返回空字符串</td><td><code>1. find(&#x27;eeabcabcee&#x27;, &#x27;abc&#x27;, &#x27;trailing&#x27;) = &#x27;abcee&#x27;</code></td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="map-函数">Map 函数<a class="hash-link" href="#map-函数" title="Direct link to heading">​</a></h5><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>map_get</td><td>取 Map 中某个 Key 的值，如果没有则返回空值</td><td><ol type="1"><li>Key 2. Map</li></ol></td><td>Map 中某个 Key 的值。支持嵌套的 Key，比如 &quot;a.b.c&quot;</td></tr><tr class="odd"><td>map_get</td><td>取 Map 中某个 Key 的值，如果没有则返回指定默认值</td><td><ol type="1"><li>Key 2. Map 3. Default Value</li></ol></td><td>Map 中某个 Key 的值。支持嵌套的 Key，比如 &quot;a.b.c&quot;</td></tr><tr class="even"><td>map_put</td><td>向 Map 中插入值</td><td><ol type="1"><li>Key 2. Value 3. Map</li></ol></td><td>插入后的 Map。支持嵌套的 Key，比如 &quot;a.b.c&quot;</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="数组函数">数组函数<a class="hash-link" href="#数组函数" title="Direct link to heading">​</a></h4><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>nth</td><td>取第 n 个元素，下标从 1 开始</td><td><ol type="1"><li>原数组</li></ol></td><td>第 n 个元素</td></tr><tr class="odd"><td>length</td><td>获取数组的长度</td><td><ol type="1"><li>原数组</li></ol></td><td>数组长度</td></tr><tr class="even"><td>sublist</td><td>取从第一个元素开始、长度为 len 的子数组。下标从 1 开始</td><td><ol type="1"><li>长度 len 2. 原数组</li></ol></td><td>子数组</td></tr><tr class="odd"><td>sublist</td><td>取从第 n 个元素开始、长度为 len 的子数组。下标从 1 开始</td><td><ol type="1"><li>起始位置 n 2. 长度 len 3. 原数组</li></ol></td><td>子数组</td></tr><tr class="even"><td>first</td><td>取第 1 个元素。下标从 1 开始</td><td><ol type="1"><li>原数组</li></ol></td><td>第 1 个元素</td></tr><tr class="odd"><td>last</td><td>取最后一个元素。</td><td><ol type="1"><li>原数组</li></ol></td><td>最后一个元素</td></tr><tr class="even"><td>contains</td><td>判断数据是否在数组里面</td><td><ol type="1"><li>数据 2. 原数组</li></ol></td><td>Boolean 值</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="哈希函数">哈希函数<a class="hash-link" href="#哈希函数" title="Direct link to heading">​</a></h5><table><colgroup><col><col><col><col></colgroup><tbody><tr class="odd"><td>函数名</td><td>函数作用</td><td>参数</td><td>返回值</td></tr><tr class="even"><td>md5</td><td>求 MD5 值</td><td><ol type="1"><li>数据</li></ol></td><td>MD5 值</td></tr><tr class="odd"><td>sha</td><td>求 SHA 值</td><td><ol type="1"><li>数据</li></ol></td><td>SHA 值</td></tr><tr class="even"><td>sha256</td><td>求 SHA256 值</td><td><ol type="1"><li>数据</li></ol></td><td>SHA256 值</td></tr></tbody></table><h5 class="anchor anchorWithStickyNavbar_nANs" id="编解码函数">编解码函数<a class="hash-link" href="#编解码函数" title="Direct link to heading">​</a></h5><h5 class="anchor anchorWithStickyNavbar_nANs" id="decode-and-encode-functions">Decode and encode functions<a class="hash-link" href="#decode-and-encode-functions" title="Direct link to heading">​</a></h5><p>{% emqxce %}</p><table><thead><tr><th>函数名</th><th>函数功能</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>base64_encode</code></td><td>BASE64 编码</td><td>要编码的二进制数据</td><td>Base64 编码的字符串</td></tr><tr><td><code>base64_decode</code></td><td>BASE64 解码</td><td>Base64 编码的字符串</td><td>解码后的二进制数据</td></tr><tr><td><code>json_encode</code></td><td>JSON 编码</td><td>要转成 JSON 的数据结构</td><td>JSON 字符串</td></tr><tr><td><code>json_decode</code></td><td>JSON 解码</td><td>要解码的 JSON 字符串</td><td>解码后的数据结构</td></tr><tr><td><code>bin2hexstr</code></td><td>二进制数据转为 Hex 字符串</td><td>二进制数据</td><td>Hex 字符串</td></tr><tr><td><code>hexstr2bin</code></td><td>Hex 字符串转为二进制数据</td><td>Hex 字符串</td><td>二进制数据</td></tr></tbody></table><p>{% endemqxce %}</p><p>{% emqxee %}</p><table><thead><tr><th>函数名</th><th>函数功能</th><th>参数</th><th>返回值</th></tr></thead><tbody><tr><td><code>base64_encode</code></td><td>BASE64 编码</td><td>要编码的二进制数据</td><td>Base64 编码的字符串</td></tr><tr><td><code>base64_decode</code></td><td>BASE64 解码</td><td>Base64 编码的字符串</td><td>解码后的二进制数据</td></tr><tr><td><code>json_encode</code></td><td>JSON 编码</td><td>要转成 JSON 的数据结构</td><td>JSON 字符串</td></tr><tr><td><code>json_decode</code></td><td>JSON 解码</td><td>要解码的 JSON 字符串</td><td>解码后的数据结构</td></tr><tr><td><code>schema_encode</code></td><td>按照 schema 编码. 依赖 <a href="/docs/developer_guid/docs/back_end/schema-registry.md">schema registry</a></td><td>1. 由 schema registry 定义的 Schema ID 2. 要编码的数据 3..N. 其他参数，跟 schema 相关</td><td>编码后的数据</td></tr><tr><td><code>schema_decode</code></td><td>按照 schema 编码. 依赖 <a href="/docs/developer_guid/docs/back_end/schema-registry.md">schema registry</a></td><td>1. 由 schema registry 定义的 Schema ID 2. 要解码的数据 3..N.  其他参数，跟 schema 相关</td><td>解码后的数据</td></tr><tr><td><code>bin2hexstr</code></td><td>二进制数据转为 Hex 字符串</td><td>二进制数据</td><td>Hex 字符串</td></tr><tr><td><code>hexstr2bin</code></td><td>Hex 字符串转为二进制数据</td><td>Hex 字符串</td><td>二进制数据</td></tr></tbody></table><p>{% endemqxee %}</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="在-dashboard-中测试-sql-语句">在 Dashboard 中测试 SQL 语句<a class="hash-link" href="#在-dashboard-中测试-sql-语句" title="Direct link to heading">​</a></h4><p>Dashboard 界面提供了 SQL 语句测试功能，通过给定的 SQL 语句和事件参数，展示 SQL 测试结果。</p><ol><li><p>在创建规则界面，输入 <strong>规则SQL</strong>，并启用 <strong>SQL 测试</strong> 开关:</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/rule-engine/sql-test-1%402x.7f6fdc2d.png" alt="sql-test-1@2x.7f6fdc2d.png" class="img_xIgF"></p></li><li><p>修改模拟事件的字段，或者使用默认的配置，点击 <strong>测试</strong> 按钮:</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/rule-engine/sql-test-2%402x.efe87e20.png" alt="sql-test-2@2x.efe87e20.png" class="img_xIgF"></p></li><li><p>SQL 处理后的结果将在 <strong>测试输出</strong> 文本框里展示:</p><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/rule-engine/sql-test-3%402x.0b6301b0.png" alt="sql-test-3@2x.0b6301b0.png" class="img_xIgF"></p></li></ol><h1>DG-IoT日志模块</h1><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/log/DG-IoT%E6%97%A5%E5%BF%97.png" alt="DG-IoT日志.png" class="img_xIgF">
DG-IoT日志系统是基于Erlang/OTP原生的日志系统基础上扩展而成，主要包含日志来源，日志处理，日志输出和日志展示四个部分</p><h2 class="anchor anchorWithStickyNavbar_nANs" id="常用枚举">常用枚举<a class="hash-link" href="#常用枚举" title="Direct link to heading">​</a></h2><p>在接口中常用的枚举将在此文档中列出。</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="devicetype">DeviceType<a class="hash-link" href="#devicetype" title="Direct link to heading">​</a></h4><table><thead><tr><th>value</th><th>text</th></tr></thead><tbody><tr><td>device</td><td>直连设备</td></tr><tr><td>childrenDevice</td><td>网关子设备</td></tr><tr><td>gateway</td><td>网关设备</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="devicestate">DeviceState<a class="hash-link" href="#devicestate" title="Direct link to heading">​</a></h4><table><thead><tr><th>value</th><th>text</th></tr></thead><tbody><tr><td>notActive</td><td>未激活</td></tr><tr><td>offline</td><td>离线</td></tr><tr><td>online</td><td>在线</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="devicelogtype">DeviceLogType<a class="hash-link" href="#devicelogtype" title="Direct link to heading">​</a></h4><table><thead><tr><th>value</th><th>text</th></tr></thead><tbody><tr><td>event</td><td>事件上报</td></tr><tr><td>readProperty</td><td>属性读取</td></tr><tr><td>writeProperty</td><td>属性修改</td></tr><tr><td>reportProperty</td><td>属性上报</td></tr><tr><td>child</td><td>子设备消息</td></tr><tr><td>childReply</td><td>子设备消息回复</td></tr><tr><td>functionInvoke</td><td>调用功能</td></tr><tr><td>readPropertyReply</td><td>读取属性回复</td></tr><tr><td>writePropertyReply</td><td>修改属性回复</td></tr><tr><td>functionReply</td><td>调用功能回复</td></tr><tr><td>register</td><td>设备注册</td></tr><tr><td>unregister</td><td>设备注销</td></tr><tr><td>offline</td><td>离线</td></tr><tr><td>online</td><td>上线</td></tr><tr><td>transparent</td><td>透传报文</td></tr><tr><td>other</td><td>其它</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_nANs" id="type">Type<a class="hash-link" href="#type" title="Direct link to heading">​</a></h4><table><thead><tr><th>value</th><th>描述</th></tr></thead><tbody><tr><td>Point</td><td>点</td></tr><tr><td>MultiPoint</td><td>多个点</td></tr><tr><td>LineString</td><td>线</td></tr><tr><td>MultiLineString</td><td>多条线</td></tr><tr><td>Polygon</td><td>多边形</td></tr><tr><td>MultiPolygon</td><td>多个多边形</td></tr><tr><td>GeometryCollection</td><td>数据集合,包含点线</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_nANs" id="批量存库架构">批量存库架构<a class="hash-link" href="#批量存库架构" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/backend/dgiot/batch/DG-IoT%E6%89%B9%E9%87%8F%E5%AD%98%E5%BA%93.png" alt="DG-IoT批量存库.png" class="img_xIgF">
DG-IoT批量存库保护数据源，缓存队列处理和批量存库三个部分</p><ul><li>第一期目标实现N此存库失败，高效存库目标，parse达到1万qps，tdenine到达2万qps</li><li>第二期目标实现零丢包高效存库</li></ul><h2 class="anchor anchorWithStickyNavbar_nANs" id="统计模块">统计模块<a class="hash-link" href="#统计模块" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="https://ww.iotn2n.com/attachment/attachment/images/2021/09/02/image_1630568725_v88Z40Y0.png" alt="image.png" class="img_xIgF"></p><p><a href="https://github.com/prometheus/pushgateway/blob/master/README.md" target="_blank" rel="noopener noreferrer">https://github.com/prometheus/pushgateway/blob/master/README.md</a></p><h4 class="anchor anchorWithStickyNavbar_nANs" id="添加一个job和instance">添加一个job和instance<a class="hash-link" href="#添加一个job和instance" title="Direct link to heading">​</a></h4><p>cat &lt;&lt;EOF | curl --data-binary @- <a href="http://127.0.0.1:9091/metrics/job/some_job/instance/some_instance" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9091/metrics/job/some_job/instance/some_instance</a></p><h4 class="anchor anchorWithStickyNavbar_nANs" id="type-some_metric-counter">TYPE some_metric counter<a class="hash-link" href="#type-some_metric-counter" title="Direct link to heading">​</a></h4><p>some_metric{label=&quot;val1&quot;} 42</p><h4 class="anchor anchorWithStickyNavbar_nANs" id="type-another_metric-gauge">TYPE another_metric gauge<a class="hash-link" href="#type-another_metric-gauge" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_nANs" id="help-another_metric-just-an-example">HELP another_metric Just an example.<a class="hash-link" href="#help-another_metric-just-an-example" title="Direct link to heading">​</a></h4><p>another_metric 2398.283
EOF</p><h3 class="anchor anchorWithStickyNavbar_nANs" id="查询metrics">查询metrics<a class="hash-link" href="#查询metrics" title="Direct link to heading">​</a></h3><p>curl -X GET <a href="http://127.0.0.1:9091/api/v1/metrics" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9091/api/v1/metrics</a></p><div class="codeBlockContainer_wJpj theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_H_Nx"><pre tabindex="0" class="prism-code language-text codeBlock_krk8 thin-scrollbar"><code class="codeBlockLines__XcK"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;status&quot;:&quot;success&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;data&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;another_metric&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;time_stamp&quot;:&quot;2021-09-02T15:26:33.59686919+08:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;:&quot;GAUGE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;help&quot;:&quot;Just an example.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;labels&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;instance&quot;:&quot;some_instance&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;job&quot;:&quot;some_job&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;value&quot;:&quot;2398.283&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;labels&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;instance&quot;:&quot;some_instance&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;job&quot;:&quot;some_job&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;last_push_successful&quot;:true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;push_failure_time_seconds&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;time_stamp&quot;:&quot;2021-09-02T15:26:33.59686919+08:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;:&quot;GAUGE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;help&quot;:&quot;Last Unix time when changing this group in the Pushgateway failed.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;labels&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;instance&quot;:&quot;some_instance&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;job&quot;:&quot;some_job&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;value&quot;:&quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;push_time_seconds&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;time_stamp&quot;:&quot;2021-09-02T15:26:33.59686919+08:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;:&quot;GAUGE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;help&quot;:&quot;Last Unix time when changing this group in the Pushgateway succeeded.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;labels&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;instance&quot;:&quot;some_instance&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;job&quot;:&quot;some_job&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;value&quot;:&quot;1.6305675935968692e+09&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;some_metric&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;time_stamp&quot;:&quot;2021-09-02T15:26:33.59686919+08:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;type&quot;:&quot;COUNTER&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;labels&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;instance&quot;:&quot;some_instance&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;job&quot;:&quot;some_job&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;label&quot;:&quot;val1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;value&quot;:&quot;42&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_wWfa"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_WPtK" aria-hidden="true"><svg class="copyButtonIcon_fMSi" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_TLff" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_nANs" id="删除某个组下的某实例的所有数据">删除某个组下的某实例的所有数据：<a class="hash-link" href="#删除某个组下的某实例的所有数据" title="Direct link to heading">​</a></h3><p>curl -X DELETE <a href="http://127.0.0.1:9091/metrics/job/some_job/instance/some_instance" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9091/metrics/job/some_job/instance/some_instance</a></p><h3 class="anchor anchorWithStickyNavbar_nANs" id="删除某个组下的所有数据">删除某个组下的所有数据：<a class="hash-link" href="#删除某个组下的所有数据" title="Direct link to heading">​</a></h3><p>curl -X DELETE <a href="http://127.0.0.1:9091/metrics/job/some_job" target="_blank" rel="noopener noreferrer">http://127.0.0.1:9091/metrics/job/some_job</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/developer_guid/docs/back_end/1.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_njZO" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_RbWX"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer_guid/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">简介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer_guid/docs/back_end/architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">太阳能管理平台</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Kf3_ thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#分层架构" class="table-of-contents__link toc-highlight"><strong>分层架构</strong></a><ul><li><a href="#严格分层架构" class="table-of-contents__link toc-highlight"><strong>严格分层架构</strong></a></li><li><a href="#松散分层架构relaxed-layered-system" class="table-of-contents__link toc-highlight"><strong>松散分层架构（Relaxed Layered System）</strong></a></li><li><a href="#继承分层架构layering-through-inheritance" class="table-of-contents__link toc-highlight"><strong>继承分层架构（Layering Through Inheritance）</strong></a></li><li><a href="#包package与分层架构" class="table-of-contents__link toc-highlight"><strong>包（Package）与分层架构</strong></a></li><li><a href="#资源库repository" class="table-of-contents__link toc-highlight"><strong>资源库（Repository）</strong></a></li><li><a href="#三层或四层架构" class="table-of-contents__link toc-highlight"><strong>三层或四层架构</strong></a></li></ul></li><li><a href="#三种模式" class="table-of-contents__link toc-highlight">三种模式</a><ul><li><a href="#ddd" class="table-of-contents__link toc-highlight"><strong>DDD</strong></a></li><li><a href="#分层架构-1" class="table-of-contents__link toc-highlight"><strong>分层架构</strong></a></li><li><a href="#小结" class="table-of-contents__link toc-highlight">小结</a></li></ul></li><li><a href="#多租户" class="table-of-contents__link toc-highlight">多租户</a><ul><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#iaas技术设施即服务" class="table-of-contents__link toc-highlight">IaaS(技术设施即服务)</a></li><li><a href="#saas软件施即服务" class="table-of-contents__link toc-highlight">SaaS(软件施即服务)</a></li><li><a href="#多租户-1" class="table-of-contents__link toc-highlight">多租户</a></li><li><a href="#案例剖析" class="table-of-contents__link toc-highlight">案例剖析</a></li></ul></li><li><a href="#插件机制" class="table-of-contents__link toc-highlight">插件机制</a><ul><li><a href="#目录结构" class="table-of-contents__link toc-highlight">目录结构</a></li><li><a href="#示例代码" class="table-of-contents__link toc-highlight">示例代码</a></li><li><a href="#加载机制" class="table-of-contents__link toc-highlight">加载机制</a></li></ul></li><li><a href="#网页代理" class="table-of-contents__link toc-highlight">网页代理</a><ul><li><a href="#反向代理" class="table-of-contents__link toc-highlight">反向代理</a></li><li><a href="#爬虫代理" class="table-of-contents__link toc-highlight">爬虫代理</a></li><li><a href="#网页代理-1" class="table-of-contents__link toc-highlight">网页代理</a></li></ul></li><li><a href="#扩展编程" class="table-of-contents__link toc-highlight">扩展编程</a><ul><li><a href="#反向代理-1" class="table-of-contents__link toc-highlight">反向代理</a></li></ul></li><li><a href="#编程规范" class="table-of-contents__link toc-highlight">编程规范</a><ul><li><a href="#摘要" class="table-of-contents__link toc-highlight">摘要</a></li><li><a href="#目标" class="table-of-contents__link toc-highlight">目标</a></li><li><a href="#结构和erlang术语" class="table-of-contents__link toc-highlight">结构和Erlang术语</a></li><li><a href="#sw工程原则" class="table-of-contents__link toc-highlight">SW工程原则</a></li><li><a href="#不要优化代码" class="table-of-contents__link toc-highlight">不要优化代码</a></li><li><a href="#错误处理" class="table-of-contents__link toc-highlight">错误处理</a></li><li><a href="#进程服务器和消息" class="table-of-contents__link toc-highlight">进程、服务器和消息</a></li><li><a href="#各种erlang特殊约定" class="table-of-contents__link toc-highlight">各种Erlang特殊约定</a></li><li><a href="#特殊的词法和风格约定" class="table-of-contents__link toc-highlight">特殊的词法和风格约定</a></li><li><a href="#文档化代码" class="table-of-contents__link toc-highlight">文档化代码</a></li><li><a href="#使用版本控制系统" class="table-of-contents__link toc-highlight">使用版本控制系统</a></li><li><a href="#常见错误" class="table-of-contents__link toc-highlight">常见错误</a></li><li><a href="#所需文档" class="table-of-contents__link toc-highlight">所需文档</a></li><li><a href="#注解" class="table-of-contents__link toc-highlight">注解:</a></li></ul></li><li><a href="#任务调度" class="table-of-contents__link toc-highlight">任务调度</a><ul><li><a href="#场景描述" class="table-of-contents__link toc-highlight">场景描述</a></li><li><a href="#分组任务" class="table-of-contents__link toc-highlight">分组任务</a></li><li><a href="#网关任务" class="table-of-contents__link toc-highlight">网关任务</a></li><li><a href="#多通道任务" class="table-of-contents__link toc-highlight">多通道任务</a></li><li><a href="#系统容量" class="table-of-contents__link toc-highlight">系统容量</a></li></ul></li><li><a href="#数据同步" class="table-of-contents__link toc-highlight">数据同步</a><ul><li><a href="#api-hook配置同步数据库-缓存" class="table-of-contents__link toc-highlight">API Hook配置同步（数据库-&gt;缓存）</a></li><li><a href="#livequery同步数据库-缓存" class="table-of-contents__link toc-highlight">Livequery同步（数据库-&gt;缓存）</a></li><li><a href="#api-hook同步数据数据库缓存--用户" class="table-of-contents__link toc-highlight">API Hook同步数据（数据库+缓存 -&gt;用户）</a></li></ul></li><li><a href="#远程定位" class="table-of-contents__link toc-highlight">远程定位</a><ul><li><a href="#解决" class="table-of-contents__link toc-highlight"><strong>解决：</strong></a></li><li><a href="#etop" class="table-of-contents__link toc-highlight">Etop</a></li><li><a href="#eprof" class="table-of-contents__link toc-highlight">eprof</a></li><li><a href="#fprof" class="table-of-contents__link toc-highlight">fprof</a></li><li><a href="#cprof" class="table-of-contents__link toc-highlight">cprof</a></li><li><a href="#webtool" class="table-of-contents__link toc-highlight">Webtool</a></li></ul></li><li><a href="#规则引擎" class="table-of-contents__link toc-highlight">规则引擎</a><ul><li><a href="#emq-x-规则引擎快速入门" class="table-of-contents__link toc-highlight">EMQ X 规则引擎快速入门</a></li><li><a href="#消息发布" class="table-of-contents__link toc-highlight">消息发布</a></li><li><a href="#事件触发" class="table-of-contents__link toc-highlight">事件触发</a></li><li><a href="#最小规则" class="table-of-contents__link toc-highlight">最小规则</a></li><li><a href="#规则引擎典型应用场景举例" class="table-of-contents__link toc-highlight">规则引擎典型应用场景举例</a></li><li><a href="#迁移指南" class="table-of-contents__link toc-highlight">迁移指南</a></li><li><a href="#规则引擎组成" class="table-of-contents__link toc-highlight">规则引擎组成</a></li><li><a href="#sql-语句" class="table-of-contents__link toc-highlight">SQL 语句</a></li></ul></li><li><a href="#常用枚举" class="table-of-contents__link toc-highlight">常用枚举</a></li><li><a href="#批量存库架构" class="table-of-contents__link toc-highlight">批量存库架构</a></li><li><a href="#统计模块" class="table-of-contents__link toc-highlight">统计模块</a><ul><li><a href="#查询metrics" class="table-of-contents__link toc-highlight">查询metrics</a></li><li><a href="#删除某个组下的某实例的所有数据" class="table-of-contents__link toc-highlight">删除某个组下的某实例的所有数据：</a></li><li><a href="#删除某个组下的所有数据" class="table-of-contents__link toc-highlight">删除某个组下的所有数据：</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">快速上手</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/dgiot/dgiot/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/dgiot/dgiot/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item">Pull Requests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/dgiot/dgiot/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">博客</a></li><li class="footer__item"><a href="https://github.com/dgiot/dgiot" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_tJJA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 dgiot, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.6f315219.js"></script>
<script src="/assets/js/main.57a13c50.js"></script>
</body>
</html>