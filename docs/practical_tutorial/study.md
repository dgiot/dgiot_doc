# 平台配置

绘制性能曲线，有```Q-H```（流量-扬程）、```Q-N```（流量-功率）、```Q-n```（流量-效率）三根曲线，蕴含有流量```Q```、扬程```H```、功率```N```和效率```n```四个变量。其中扬程```H```是根据进出口压力```f```得到的，
效率```n```由流量、扬程和压力计算得到。故，只需要流量```Q```、功率```N```、进出口压力```f```这四个变量参数即可。

![xnqx.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/xnqx.png)

## Step 1:配置好通道

![channel.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/channel.png)

通过登录我们的平台，进入到```通道```界面。点击```创建通道```，依次创建三个通道，分别是```指令任务通道```、```DG-IoT水泵控制器采集通道```和```TD资源通道```。

![channel_create.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/channel_create.png)

```指令任务通道```是给dtu下达采集任务指令，用于物接入。需要设置的有```开始时间```、```结束时间```、```采集频率```和```池子大小```这几个参数。其中```池子大小```改为1即可。

![channel_task.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/channel_task.png)

```DG-IoT水泵控制器采集通道```是和dtu进行连接通讯，用于物接入。需要设置的有```端口```，```登录报文帧头```和```池子大小```这几个参数。其中，```端口```和```登录报文帧头```要与连接的dtu保持一致。```池子大小```也改为1。

dtu如何设置与我们平台通讯，可转到[dtu配置页面](dtu.md)。

![channel_dtu.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/channel_dtu.png)

```TD资源通道```用于存储dtu传输的时序数据，用于物存储。其中设置好```服务器地址```、```端口```、```用户```、```密码```和```池子大小```这几个参数。

![channel_td.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/channel_td.png)

## Step 2：配置好分组

配置好三个通道后，接下来是配置好分组。```分组```是将同用这三个通道的产品设备划为同一组。点击```新建```，新建成功后，在```物接入```处```选择通道```，将刚刚设置的指令任务通道和DG-IoT水泵控制器采集通道添加进去。

![group.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/group.png)

同理，在物存储处添加```TD资源通道```。

## Step 3：配置好产品和设备

接下来，在通道页面，将配置好的```DG-IoT水泵控制器采集通道```启用。系统会自动生成一个产品和一个设备。设备即为我们用```DG-IoT水泵控制器采集通道```运行后绑定的dtu。设备的id与dtu的id一致。

在产品页面，选择刚刚生成好的产品，在其右侧，点击```配置```， 即可进入产品的编辑页面。

![product.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/product.png)

### 物模型

在物模型处我们配置不同的物模型，每个物模型分别与不同的传感器检测参数对应。

![model.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/model.png)

点击```编辑```或者```新增自定义属性```，即可对物模型进行编辑。

![object_model.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/object_model.png)

其中每一个空格的含义如下：

| 名称| 含义 |  
| ------------ | ------------ |
|功能名称|物模型的作用，实现的功能|
|标识符|唯一识别物模型，一般用功能名称的英译|
|取值范围（数值）|物模型的取值范围|
|步长|即step，物模型取值依次增长的幅度|
|读写类型|读写；文档或属性既能读取，也能修改;  只读:又称唯读，表示文档或属性只能读取，不能修改，也不能存储|
|数据类型|物模型的数据类型，可选择|
|采集策略|可填入数值，代表是采集时间间隔；也可选择不采集（计算值）和不采集（主动上报）|
|采集公式|我们需要的数据与采集的数据之间的数学关系式；%q:对应的是数据标识第二个空里面的数据;%s:采集到的数据;%r:采集的轮次|
|控制公式|控制数据采集的次数或者满足特殊的采集需求（true为1,false为大于1的其他数字。语言erlang）|
|数据标识第一个空|address地址值。如果是modbus协议，则数据标识表示传感器的寄存器地址。否则用唯一数字字母组合标识即可。相应传感器说明手册可查|
|数据标识第二个空|即%q。如果读写类型选的只读，则此处填字节数。如果读写类型选的读写，用于modbus协议，表示参数地址，或模拟量的功能码。相应传感器说明手册可查。进制，十进制。|
|协议类型|我们可以选择modbus协议，否则就是normal|
|字节序|大端：高位字节排放在内存的低地址端，低位字节排放在内存的高地址端。小端：低位字节排放在内存的低地址端，高位字节排放在内存的高地址端。|
|寄存器状态|线圈状态：读从机离散量输出口的on/off状态。读输入状态：读从机离散量输入信号的on/off状态。保持寄存器：可以通过通信命令读或者写的寄存器。输入寄存器：只能读不能写的寄存器。|
|从机地址|从机的address，用于modbus通讯。传感器的说明手册可查，也可根据需要在传感器里更改。进制：十进制。|

例如，我们需要测量水泵运行的流量，就需要用到流量计进行测量。这个时候我们创建一个```流量```物模型。然后用```flow```做其标识符。取值范围根据实际情况取就行。读写类型选择只读。数据类型选择浮点值。
因为是采集到的数据，采集公式填入```%s```即可。剩余的部分根据其代表的含义查阅流量计说明书即可。

但我们发现，有些参数是通过计算得到的。比如，扬程```H```是根据进出口压力```f```得到的。这样我们添加```扬程```这个物模型时该怎么设置呢？

因为是计算得到的，读写类型设置为读写。采集策略选择不采集（计算值）。采集公式写计算公式。注意，如果采集公式用到其他物模型参数，需要在其前面加上两个```%%```。比如```%%flow```代表的是采集的物模型流量的值。

### 指令

配置好物模型，有些物模型时需要采集上来得到的，现在我们就需要配置其采集指令。平台通过采集指令来采集传感器收集的数据。

进入指令设置界面的途径：点击```设备```，在设备列表中找到使用的设备，点击```查看```，在功能列表中找到```设备指令```。

![instruct.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/instruct.png)

在这个页面，你可以新增或者删除指令。也可以编辑、启用或者禁用指令。

![instruct_edit.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/instruct_edit.png)

各项含义如下表：

| 名称| 含义 |  
| ------------ | ------------ |
|指令名称|该指令的名称，与物模型的功能名称对应|
|指令指标|可用寄存器地址表示|
|操作类型|操作类型与物模型的读写类型对应|
|指令序号|可设置指令下发顺序，格式阿拉伯数字|
|超时时长|用于防止某个信号的缺失导致采集指令的中断。信号采集时间时间超过设置时长，则直接转到下一轮指令|
|子网编号|内网地址。格式可用：从站/寄存器地址|
|生效轮次|该指令起作用的轮次。可通过下拉框选择第一轮、最后一轮或全部；也可自行输入生效轮次，阿拉伯数字中间加逗号隔开|
|发送间隔|指令发送时间间隔|

将上述指令配置好后，我们就可以通过启用```指令任务通道```和```TD资源通道```，来实现传感器数据的采集了。采集的数据就可以用来计算绘制性能曲线图了。

如果想实现全自动，也可以加一个电动阀门，给电动阀门发指令来控制流量即可。

## 组态展示

如果想实时展示采集到的数据，平台也有内置的组态展示模块。

我们通过依次进入```分组```-```编辑组态```或```设备```-```视图```或```产品```-```编辑组态```来进入组态的编辑与查看界面。

![show.png](http://dgiot-1253666439.cos.ap-shanghai-fsi.myqcloud.com/shuwa_tech/zh/blog/study/pump/show.png)

组态过程：

+ 背景图上传

点击```上传背景图```，选择一张图作为背景图。确认```保存```。

+ 数据条的拉取

在界面左侧有不同的控件，我们通过拉取，将我们需要的控件拖入到图片相应位置。比如我们可以拖入三个text框并排在一起。分别写入测量量和单位。中间的text框
可以通过点击```数据```，在```名称```栏选择相应的物模型。